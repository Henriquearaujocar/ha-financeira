<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light">
    <title>Solicitar Cr√©dito | CMS Ventures</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root { color-scheme: light only; }
        html, body { background-color: #020617 !important; color: #f1f5f9 !important; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.05); }
        .input-field { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 1.25rem; padding: 1.25rem; width: 100%; outline: none; transition: 0.3s; }
        .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        .input-field:read-only { background: rgba(15, 23, 42, 0.4); border-color: rgba(16, 185, 129, 0.2); color: #94a3b8; }
        
        /* üö® CORRE√á√ÉO VISUAL: For√ßa um fundo escuro s√≥lido nas op√ß√µes do Select para evitar texto invis√≠vel */
        .input-field option { background-color: #0f172a; color: #f8fafc; font-weight: 600; }
        
        .file-label { display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(15, 23, 42, 0.8); border: 1px dashed rgba(255,255,255,0.2); border-radius: 1.25rem; padding: 1.5rem; cursor: pointer; transition: 0.3s; text-align: center; overflow: hidden; position: relative;}
        .file-label:hover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
        
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative" onload="inicializarFormulario()">
    
    <div class="fixed top-[-10%] left-[-10%] w-[300px] h-[300px] bg-blue-600 rounded-full mix-blend-multiply filter blur-[100px] opacity-20 pointer-events-none"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[300px] h-[300px] bg-emerald-600 rounded-full mix-blend-multiply filter blur-[100px] opacity-10 pointer-events-none"></div>

    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[200] hidden transition-all duration-300">
        <div class="bg-slate-900 border border-white/10 px-6 py-4 rounded-full shadow-2xl flex items-center gap-3">
            <i id="toastIcon" class="fa-solid fa-circle-check text-emerald-500 text-xl"></i>
            <p id="toastMsg" class="text-sm font-bold tracking-wide"></p>
        </div>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[150] hidden flex flex-col items-center justify-center">
        <i class="fa-solid fa-circle-notch fa-spin text-6xl text-blue-500 mb-4"></i>
        <h2 class="text-xl font-black uppercase tracking-widest text-white">A processar...</h2>
        <p class="text-slate-400 text-sm mt-2">A otimizar ficheiros e validar dados.</p>
    </div>

    <main class="glass-card w-full max-w-4xl rounded-[2rem] p-8 md:p-12 relative z-10 my-8 shadow-2xl">
        
        <div class="text-center mb-10">
            <img src="/logo.png" alt="CMS Ventures" onerror="this.style.display='none'" class="h-20 mx-auto mb-4 object-contain drop-shadow-xl">
            <h1 class="text-3xl md:text-4xl font-black italic text-blue-500 tracking-tighter uppercase">CMS Ventures</h1>
            <p class="text-[10px] md:text-xs font-black uppercase text-slate-500 tracking-[0.2em] mt-2">Formul√°rio de An√°lise de Cr√©dito</p>
        </div>

        <form id="formSolicitacao" class="space-y-8" onsubmit="event.preventDefault(); enviarProposta();">
            
            <div class="bg-blue-900/10 border border-blue-500/20 p-6 rounded-2xl mb-8 flex flex-col items-center justify-center">
                <h3 class="text-sm font-black uppercase text-blue-400 mb-2"><i class="fa-solid fa-rotate mr-2"></i>J√° √© nosso cliente?</h3>
                <p class="text-xs text-slate-400 mb-4 text-center">Informe o seu CPF para reaproveitarmos os seus dados.</p>
                
                <div class="flex gap-2 w-full max-w-md">
                    <input type="text" id="cpf_busca" placeholder="Digite seu CPF..." class="input-field py-3 text-center text-sm" maxlength="14" oninput="mascaraCPF(this)">
                    <button type="button" onclick="buscarClienteExistente()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-6 py-3 rounded-xl transition-all"><i class="fa-solid fa-magnifying-glass"></i></button>
                    <button type="button" id="btn_limpar_busca" onclick="limparBusca()" class="hidden bg-slate-700 hover:bg-red-600 text-white font-bold px-4 py-3 rounded-xl transition-all" title="Limpar e recome√ßar"><i class="fa-solid fa-eraser"></i></button>
                </div>
            </div>

            <!-- 1. Dados Pessoais -->
            <div class="space-y-4">
                <h3 class="text-sm font-black uppercase text-blue-400 border-b border-slate-700 pb-2"><i class="fa-solid fa-user mr-2"></i>1. Dados Pessoais</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Nome Completo</label>
                        <input type="text" id="nome" placeholder="Digite seu nome e apelido" class="input-field mt-1" maxlength="100" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-2">CPF</label>
                        <input type="text" id="cpf" placeholder="000.000.000-00" class="input-field mt-1" maxlength="14" oninput="mascaraCPF(this)" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-2">WhatsApp</label>
                        <input type="tel" id="whatsapp" placeholder="(00) 00000-0000" class="input-field mt-1" maxlength="15" oninput="mascaraTel(this)" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-2">CPF do Promotor (Opcional)</label>
                        <input type="text" id="indicado_por" placeholder="000.000.000-00" class="input-field mt-1" maxlength="14" oninput="mascaraCPF(this)">
                    </div>
                </div>
            </div>

            <!-- 2. Detalhes do Cr√©dito -->
            <div class="space-y-4">
                <h3 class="text-sm font-black uppercase text-blue-400 border-b border-slate-700 pb-2"><i class="fa-solid fa-money-bill-wave mr-2"></i>2. Estrutura Desejada</h3>
                
                <div class="bg-blue-900/10 border border-blue-500/20 p-6 rounded-2xl mb-4">
                    <label class="text-xs font-black uppercase text-slate-400 block mb-2">Valor Desejado (R$)</label>
                    <input type="number" id="valor" placeholder="A carregar limites..." class="input-field font-black text-2xl text-emerald-400" onkeydown="if(['e', 'E', '+', '-', ',', '.'].includes(event.key)) event.preventDefault();" oninput="limitarValor(this)" required>
                    <p id="texto-minimo" class="text-[10px] text-slate-500 mt-2"><i class="fa-solid fa-circle-info mr-1"></i> A carregar valor m√≠nimo...</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Plano de Pagamento</label>
                        <select id="tipo_plano" class="input-field mt-1" onchange="atualizarInterface()">
                            <option value="30DIAS">Padr√£o (√önica em 30 Dias)</option>
                            <option value="PARCELADO">Parcelado</option>
                        </select>
                    </div>
                    <div id="box-frequencia" class="hidden">
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Frequ√™ncia</label>
                        <select id="frequencia" class="input-field mt-1" onchange="atualizarParcelas()">
                            <option value="MENSAL">Mensal</option>
                            <option value="SEMANAL">Semanal</option>
                        </select>
                    </div>
                    <div id="box-parcelas" class="hidden">
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">N¬∫ de Parcelas</label>
                        <select id="qtd_parcelas" class="input-field mt-1" onchange="calcularSimulacao()"></select>
                    </div>
                </div>

                <div id="simuladorBox" class="bg-slate-900 border border-slate-700 rounded-2xl p-6 mt-4 hidden transition-all">
                    <h4 class="text-[10px] font-black uppercase tracking-widest text-blue-500 mb-2 text-center"><i class="fa-solid fa-clipboard-check mr-2"></i> Estrutura da Proposta</h4>
                    <p class="text-center text-white text-lg font-black uppercase tracking-widest" id="sim_plano">--</p>
                    <p class="text-[9px] text-slate-500 mt-3 text-center bg-slate-800/50 p-2 rounded-lg">*O valor exato das parcelas com as taxas aplicadas ser√° apresentado a si pelo nosso Gestor ap√≥s a an√°lise de cr√©dito.</p>
                </div>
            </div>

            <!-- 3. Refer√™ncia Pessoal -->
            <div class="space-y-4">
                <h3 class="text-sm font-black uppercase text-blue-400 border-b border-slate-700 pb-2"><i class="fa-solid fa-address-book mr-2"></i>3. Refer√™ncia Pessoal</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Nome da Refer√™ncia</label>
                        <input type="text" id="ref1_nome" placeholder="Ex: Maria Silva (M√£e)" class="input-field mt-1" maxlength="100" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Telefone da Refer√™ncia</label>
                        <input type="tel" id="ref1_tel" placeholder="(00) 00000-0000" class="input-field mt-1" maxlength="15" oninput="mascaraTel(this)" required>
                    </div>
                </div>
            </div>

            <!-- 4. Documenta√ß√£o Obrigat√≥ria -->
            <div class="space-y-4">
                <h3 class="text-sm font-black uppercase text-blue-400 border-b border-slate-700 pb-2"><i class="fa-solid fa-file-shield mr-2"></i>4. Documenta√ß√£o</h3>
                <p id="txt-documentacao" class="text-xs text-slate-400 mb-4 bg-slate-800/50 p-3 rounded-xl border border-slate-700">Envie fotos n√≠tidas para n√£o atrasar a an√°lise.</p>
                
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <label class="file-label">
                        <i class="fa-solid fa-camera text-3xl text-slate-400 mb-3 transition-colors"></i>
                        <span class="text-[10px] font-black uppercase" id="lbl_img_selfie">Sua Selfie</span>
                        <input type="file" id="img_selfie" accept="image/*" class="hidden" onchange="marcarUpload(this)">
                    </label>
                    <label class="file-label doc-antigo">
                        <i class="fa-solid fa-id-card text-3xl text-slate-400 mb-3 transition-colors"></i>
                        <span class="text-[10px] font-black uppercase" id="lbl_img_frente">Doc. Frente</span>
                        <input type="file" id="img_frente" accept="image/*" class="hidden" onchange="marcarUpload(this)">
                    </label>
                    <label class="file-label doc-antigo">
                        <i class="fa-solid fa-id-card text-3xl text-slate-400 mb-3 transition-colors"></i>
                        <span class="text-[10px] font-black uppercase" id="lbl_img_verso">Doc. Verso</span>
                        <input type="file" id="img_verso" accept="image/*" class="hidden" onchange="marcarUpload(this)">
                    </label>
                    <label class="file-label text-center col-span-2 md:col-span-1">
                        <i class="fa-solid fa-file-invoice text-3xl text-slate-400 mb-3 transition-colors"></i>
                        <span class="text-[10px] font-black uppercase" id="lbl_img_residencia">Comp. Resid√™ncia</span>
                        <input type="file" id="img_residencia" accept="image/*" class="hidden" onchange="marcarUpload(this)">
                    </label>
                    <label class="file-label doc-antigo col-span-2 md:col-span-2">
                        <i class="fa-solid fa-house text-3xl text-slate-400 mb-3 transition-colors"></i>
                        <span class="text-[10px] font-black uppercase" id="lbl_img_casa">Fachada da Casa (N¬∫ Vis√≠vel)</span>
                        <input type="file" id="img_casa" accept="image/*" class="hidden" onchange="marcarUpload(this)">
                    </label>
                </div>
            </div>

            <button type="submit" id="btnEnviar" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black uppercase py-5 rounded-[1.25rem] transition-all shadow-[0_10px_30px_rgba(59,130,246,0.3)] mt-8 text-lg flex items-center justify-center gap-3">
                <i class="fa-solid fa-paper-plane"></i> Submeter Solicita√ß√£o
            </button>
            <p id="erroGeral" class="text-red-400 text-xs font-bold text-center hidden mt-2"></p>
        </form>
    </main>

    <script>
        const API_BASE = window.location.origin;

        let VALOR_MINIMO = 500;
        let imagensBase64 = {};
        let isClienteRecorrente = false;
        let uploadsEmAndamento = 0; 

        function validarCPFReal(cpfStr) {
            let str = cpfStr.replace(/\D/g, '');
            if (str.length !== 11 || /^(\d)\1{10}$/.test(str)) return false;
            let soma = 0, resto;
            for (let i = 1; i <= 9; i++) soma += parseInt(str.substring(i-1, i)) * (11 - i);
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(str.substring(9, 10))) return false;
            soma = 0;
            for (let i = 1; i <= 10; i++) soma += parseInt(str.substring(i-1, i)) * (12 - i);
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(str.substring(10, 11))) return false;
            return true;
        }

        async function inicializarFormulario() {
            try {
                const res = await fetch(`${API_BASE}/api/config-publica`);
                if(res.ok) {
                    const confs = await res.json();
                    confs.forEach(c => {
                        if(c.chave === 'valor_minimo') VALOR_MINIMO = parseFloat(c.valor) || 500;
                    });
                }
            } catch (e) { console.warn("A usar valores padr√£o do sistema."); }
            
            document.getElementById('valor').placeholder = `Min: R$ ${VALOR_MINIMO.toFixed(2)}`;
            document.getElementById('texto-minimo').innerHTML = `<i class="fa-solid fa-circle-info mr-1"></i> O valor m√≠nimo para solicita√ß√£o √© de R$ ${VALOR_MINIMO.toFixed(2)}.`;
        }

        async function buscarClienteExistente() {
            const cpfBusca = document.getElementById('cpf_busca').value.replace(/\D/g, '');
            if (cpfBusca.length !== 11 || !validarCPFReal(cpfBusca)) return showToast("Digite um CPF matematicamente v√°lido para buscar.", "error");

            const loading = document.getElementById('loadingOverlay');
            loading.classList.remove('hidden');

            try {
                const res = await fetch(`${API_BASE}/api/buscar-cliente-publico/${cpfBusca}`);
                if (res.ok) {
                    const cliente = await res.json();
                    
                    document.getElementById('nome').value = cliente.nome;
                    document.getElementById('cpf').value = cpfBusca;
                    document.getElementById('cpf').readOnly = true;
                    document.getElementById('whatsapp').value = cliente.telefone;
                    
                    isClienteRecorrente = true;
                    document.getElementById('btn_limpar_busca').classList.remove('hidden');

                    delete imagensBase64.img_frente;
                    delete imagensBase64.img_verso;
                    delete imagensBase64.img_casa;

                    const labelsAntigos = document.querySelectorAll('.doc-antigo');
                    labelsAntigos.forEach(label => {
                        label.style.display = 'none';
                        if(label.querySelector('input')) label.querySelector('input').required = false; 
                        
                        label.style.opacity = '1';
                        label.style.borderColor = 'rgba(255,255,255,0.2)';
                        label.style.backgroundColor = 'rgba(15, 23, 42, 0.8)';
                        label.querySelector('span').style.color = 'white';
                        const originalSpanText = label.querySelector('input').id === 'img_frente' ? 'Doc. Frente' : (label.querySelector('input').id === 'img_verso' ? 'Doc. Verso' : 'Fachada da Casa (N¬∫ Vis√≠vel)');
                        label.querySelector('span').innerText = originalSpanText;
                        label.querySelector('i').className = 'fa-solid fa-id-card text-3xl text-slate-400 mb-3 transition-colors'; 
                        if(label.querySelector('input')) label.querySelector('input').value = '';
                    });

                    document.getElementById('txt-documentacao').innerHTML = `<i class="fa-solid fa-check-circle text-emerald-500 mr-2"></i> <strong>Bem-vindo de volta!</strong> Reaproveitamos os seus documentos antigos. Anexe apenas uma Selfie e comprovante de morada.`;
                    document.getElementById('txt-documentacao').className = "text-xs text-emerald-400 mb-4 bg-emerald-900/20 p-3 rounded-xl border border-emerald-500/20";

                    showToast("Dados encontrados! Prossiga com o pedido.");
                } else {
                    showToast("Nenhum cliente antigo encontrado. Siga normalmente.", "error");
                    isClienteRecorrente = false;
                    
                    const labelsAntigos = document.querySelectorAll('.doc-antigo');
                    labelsAntigos.forEach(label => {
                        label.style.display = 'flex';
                        if(label.querySelector('input')) label.querySelector('input').required = true; 
                    });
                    document.getElementById('txt-documentacao').innerHTML = `Envie fotos n√≠tidas para n√£o atrasar a an√°lise.`;
                    document.getElementById('txt-documentacao').className = "text-xs text-slate-400 mb-4 bg-slate-800/50 p-3 rounded-xl border border-slate-700";
                }
            } catch (err) {
                showToast("Erro na liga√ß√£o com o servidor.", "error");
            } finally {
                loading.classList.add('hidden');
            }
        }

        function limparBusca() {
            isClienteRecorrente = false;
            document.getElementById('cpf_busca').value = '';
            document.getElementById('nome').value = '';
            document.getElementById('cpf').value = '';
            document.getElementById('cpf').readOnly = false;
            document.getElementById('whatsapp').value = '';
            document.getElementById('btn_limpar_busca').classList.add('hidden');

            const labelsAntigos = document.querySelectorAll('.doc-antigo');
            labelsAntigos.forEach(label => {
                label.style.display = 'flex';
                if(label.querySelector('input')) label.querySelector('input').required = true;
            });
            document.getElementById('txt-documentacao').innerHTML = `Envie fotos n√≠tidas para n√£o atrasar a an√°lise.`;
            document.getElementById('txt-documentacao').className = "text-xs text-slate-400 mb-4 bg-slate-800/50 p-3 rounded-xl border border-slate-700";
            showToast("Pesquisa limpa. Pode preencher livremente.", "success");
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            document.getElementById('toastIcon').className = type === 'success' ? 'fa-solid fa-circle-check text-emerald-500 text-xl' : 'fa-solid fa-triangle-exclamation text-red-500 text-xl';
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4500);
        }

        function marcarUpload(input) {
            const file = input.files[0];
            const label = input.parentElement;

            if (!file) {
                delete imagensBase64[input.id];
                label.style.opacity = '1';
                label.style.borderColor = 'rgba(255,255,255,0.2)';
                label.style.backgroundColor = 'rgba(15, 23, 42, 0.8)';
                label.querySelector('span').style.color = 'white';
                
                const origText = document.getElementById(`lbl_${input.id}`).dataset.orig || document.getElementById(`lbl_${input.id}`).innerText;
                if(!document.getElementById(`lbl_${input.id}`).dataset.orig) document.getElementById(`lbl_${input.id}`).dataset.orig = origText;
                
                label.querySelector('span').innerText = origText === 'ANEXADO' ? (input.id.replace('img_', '')) : origText;
                
                const iconMap = { 'img_selfie': 'fa-camera', 'img_frente': 'fa-id-card', 'img_verso': 'fa-id-card', 'img_residencia': 'fa-file-invoice', 'img_casa': 'fa-house' };
                label.querySelector('i').className = `fa-solid ${iconMap[input.id] || 'fa-upload'} text-3xl text-slate-400 mb-3 transition-colors`;
                return;
            }

            if (file.size > 15 * 1024 * 1024) {
                showToast("Esta imagem √© demasiado grande e pode travar o seu telem√≥vel. Por favor, escolha uma foto mais leve.", "error");
                input.value = '';
                return;
            }

            label.style.opacity = '0.5';
            label.querySelector('i').className = 'fa-solid fa-spinner fa-spin text-3xl mb-3 text-blue-500';
            label.querySelector('span').innerText = 'A PROCESSAR...';
            
            uploadsEmAndamento++;
            document.getElementById('btnEnviar').disabled = true;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                
                img.onerror = () => {
                    showToast("Ficheiro inv√°lido ou corrompido. Escolha uma imagem v√°lida.", "error");
                    label.style.opacity = '1';
                    label.querySelector('i').className = 'fa-solid fa-triangle-exclamation text-3xl mb-3 text-red-500';
                    label.querySelector('span').innerText = 'ERRO - TENTE NOVAMENTE';
                    label.querySelector('span').style.color = '#ef4444';
                    input.value = ''; 
                    
                    uploadsEmAndamento--;
                    if(uploadsEmAndamento === 0) document.getElementById('btnEnviar').disabled = false;
                };

                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800;
                    const scaleSize = img.width > MAX_WIDTH ? MAX_WIDTH / img.width : 1;
                    canvas.width = img.width * scaleSize;
                    canvas.height = img.height * scaleSize;

                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const base64Comprimido = canvas.toDataURL('image/jpeg', 0.5);
                    
                    imagensBase64[input.id] = base64Comprimido;
                    
                    label.style.opacity = '1';
                    label.style.borderColor = '#10b981'; 
                    label.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
                    label.querySelector('span').style.color = '#10b981';
                    label.querySelector('span').innerText = 'ANEXADO';
                    label.querySelector('i').className = 'fa-solid fa-check-circle text-3xl mb-3 text-emerald-500 transition-colors';
                    
                    uploadsEmAndamento--;
                    if(uploadsEmAndamento === 0) document.getElementById('btnEnviar').disabled = false;
                };
            };
        }

        function limitarValor(i) {
            if (i.value.length > 7) i.value = i.value.slice(0, 7);
            calcularSimulacao();
        }

        const vInput = document.getElementById('valor');
        const pSelect = document.getElementById('tipo_plano');
        const fSelect = document.getElementById('frequencia');
        const qSelect = document.getElementById('qtd_parcelas');
        
        const boxFreq = document.getElementById('box-frequencia');
        const boxParc = document.getElementById('box-parcelas');
        const simBox = document.getElementById('simuladorBox');
        
        function atualizarInterface() {
            const plano = pSelect.value;
            if (plano === '30DIAS') {
                boxFreq.classList.add('hidden');
                boxParc.classList.add('hidden');
            } else {
                boxFreq.classList.remove('hidden');
                boxParc.classList.remove('hidden');
                atualizarParcelas();
            }
            calcularSimulacao();
        }

        function atualizarParcelas() {
            const freq = fSelect.value;
            const valorAtual = parseInt(qSelect.value);
            
            qSelect.innerHTML = '';
            const max = freq === 'MENSAL' ? 12 : 24;
            
            for (let i = 2; i <= max; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = `${i}x Parcelas`;
                qSelect.appendChild(option);
            }
            
            if (valorAtual && valorAtual >= 2 && valorAtual <= max) {
                qSelect.value = valorAtual;
            } else {
                qSelect.value = 2;
            }
            calcularSimulacao();
        }

        function calcularSimulacao() {
            const valorBase = parseFloat(vInput.value) || 0;
            const plano = pSelect.value;
            const freq = fSelect.value;
            let parcelas = parseInt(qSelect.value) || 1;

            if (valorBase >= VALOR_MINIMO) {
                simBox.classList.remove('hidden');
                if (plano === '30DIAS') {
                    document.getElementById('sim_plano').innerText = 'Plano: √önica Parcela (30 Dias)';
                } else {
                    document.getElementById('sim_plano').innerText = `Plano: ${parcelas}x ${freq}`;
                }
            } else {
                simBox.classList.add('hidden');
            }
        }

        vInput.addEventListener('input', calcularSimulacao);
        pSelect.addEventListener('change', atualizarInterface);
        fSelect.addEventListener('change', atualizarParcelas);
        qSelect.addEventListener('change', calcularSimulacao);

        async function enviarProposta() {
            const form = document.getElementById('formSolicitacao');
            const erroEl = document.getElementById('erroGeral');
            const btnEnviar = document.getElementById('btnEnviar');
            
            erroEl.classList.add('hidden');

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const nomeLimpo = document.getElementById('nome').value.trim().replace(/\s+/g, ' ');
            if (nomeLimpo.split(' ').length < 2) {
                erroEl.innerText = "Por favor, insira o seu nome completo (com apelido).";
                erroEl.classList.remove('hidden');
                return;
            }

            const cpfLimpo = document.getElementById('cpf').value;
            if (!validarCPFReal(cpfLimpo)) {
                erroEl.innerText = "O CPF introduzido n√£o √© v√°lido. Verifique os n√∫meros.";
                erroEl.classList.remove('hidden');
                return;
            }

            const valorDesejado = parseFloat(vInput.value) || 0;
            if(valorDesejado < VALOR_MINIMO) {
                erroEl.innerText = `O valor m√≠nimo para solicita√ß√£o √© de R$ ${VALOR_MINIMO.toFixed(2)}.`;
                erroEl.classList.remove('hidden');
                return;
            }

            const fotosObrigatorias = isClienteRecorrente ? ['img_selfie', 'img_residencia'] : ['img_selfie', 'img_frente', 'img_verso', 'img_residencia', 'img_casa'];
            
            for (let id of fotosObrigatorias) {
                if (!imagensBase64[id]) {
                    erroEl.innerText = `Falta anexar uma ou mais fotografias obrigat√≥rias.`;
                    erroEl.classList.remove('hidden');
                    return;
                }
            }

            const originalBtnHtml = btnEnviar.innerHTML;
            btnEnviar.disabled = true;
            btnEnviar.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> A ENVIAR DADOS...';

            const loading = document.getElementById('loadingOverlay');
            loading.classList.remove('hidden');

            try {
                const dados = {
                    is_recorrente: isClienteRecorrente,
                    nome: nomeLimpo,
                    cpf: cpfLimpo.replace(/\D/g, ''),
                    whatsapp: document.getElementById('whatsapp').value.replace(/\D/g, ''),
                    valor: valorDesejado,
                    tipo_plano: pSelect.value,
                    frequencia: fSelect.value,
                    qtd_parcelas: pSelect.value === '30DIAS' ? 1 : parseInt(qSelect.value),
                    indicado_por: document.getElementById('indicado_por').value.replace(/\D/g, '') || 'DIRETO',
                    
                    url_selfie: imagensBase64.img_selfie,
                    url_residencia: imagensBase64.img_residencia,
                    url_frente: imagensBase64.img_frente,
                    url_verso: imagensBase64.img_verso,
                    url_casa: imagensBase64.img_casa,
                    
                    referencia1_nome: document.getElementById('ref1_nome').value.trim().replace(/\s+/g, ' '),
                    referencia1_tel: document.getElementById('ref1_tel').value.replace(/\D/g, ''), 
                    status: 'PENDENTE'
                };

                const res = await fetch(`${API_BASE}/api/enviar-solicitacao`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                if (res.ok) {
                    showToast("SOLICITA√á√ÉO ENVIADA COM SUCESSO!");
                    form.innerHTML = `
                        <div class="text-center py-12 space-y-4">
                            <i class="fa-solid fa-circle-check text-7xl text-emerald-500 mb-6 drop-shadow-[0_0_20px_rgba(16,185,129,0.5)]"></i>
                            <h2 class="text-3xl font-black text-white uppercase italic">An√°lise em Andamento!</h2>
                            <p class="text-slate-400 font-bold text-lg">Os seus documentos foram recebidos.</p>
                            <p class="text-sm text-slate-500 mt-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700">A nossa equipa validar√° o valor e as taxas para o seu perfil e entrar√° em contacto atrav√©s do WhatsApp muito em breve.</p>
                        </div>
                    `;
                } else {
                    const errText = await res.text();
                    try {
                        const errObj = JSON.parse(errText);
                        throw new Error(errObj.details || errObj.erro || "Falha ao processar a solicita√ß√£o.");
                    } catch(jsonErr) {
                        if(jsonErr.message.includes("Falha")) throw jsonErr;
                        throw new Error("O servidor est√° temporariamente indispon√≠vel. Tente de novo em instantes.");
                    }
                }
            } catch (err) { 
                console.error(err);
                erroEl.innerText = err.message;
                erroEl.classList.remove('hidden');
                
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = originalBtnHtml;
            } finally {
                loading.classList.add('hidden');
            }
        }

        function mascaraCPF(i) {
            let v = i.value.replace(/\D/g, ''); 
            if (v.length > 11) v = v.substring(0, 11);
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            i.value = v;
        }

        function mascaraTel(i) {
            let v = i.value.replace(/\D/g, '');
            if (v.length > 11) v = v.substring(0, 11);
            v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
            v = v.replace(/(\d)(\d{4})$/, '$1-$2');
            i.value = v;
        }
    </script>
</body>
</html>