<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Ventures | Master Cockpit</title>
    <!-- Resolve o erro 401 do favicon silenciosamente -->
    <link rel="icon" href="data:,">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { background-color: #020617; color: #f1f5f9; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass-card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .tab-active { color: #3b82f6 !important; border-right: 4px solid #3b82f6; background: linear-gradient(to right, transparent, rgba(59, 130, 246, 0.1)); }
        .input-dark { background: rgba(2, 6, 23, 0.8); border: 1px solid rgba(255,255,255,0.1); outline: none; transition: 0.3s; color: white; width: 100%; padding: 0.75rem 1rem; border-radius: 0.75rem; }
        .input-dark:focus { border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .dropdown-menu { display: none; }
        .dropdown-menu.show { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden" onload="initApp()">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[200] hidden transition-all duration-300">
        <div class="bg-slate-900 border border-white/10 px-6 py-3 rounded-full shadow-2xl flex items-center gap-3">
            <i id="toastIcon" class="fa-solid fa-circle-check text-emerald-500"></i>
            <p id="toastMsg" class="text-xs font-black uppercase tracking-widest"></p>
        </div>
    </div>

    <!-- Sidebar Completa -->
    <aside class="w-64 glass-card border-r border-slate-800 flex flex-col h-full relative z-20">
        <div class="p-6 text-center border-b border-slate-800">
            <h1 class="text-2xl font-black italic text-blue-500 tracking-tighter uppercase drop-shadow-[0_0_10px_rgba(59,130,246,0.5)]">CMS Ventures</h1>
            <p class="text-[8px] font-black uppercase text-slate-500 tracking-[0.3em] mt-1">Master Cockpit</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <p class="text-[9px] font-black text-slate-600 uppercase tracking-widest px-6 mb-2 mt-2">Operacional</p>
            <button onclick="mudarAba('dashboard')" id="nav-dashboard" class="w-full text-left px-6 py-3 text-xs font-bold text-slate-400 hover:text-white transition-all tab-active"><i class="fa-solid fa-chart-pie w-6"></i> Dashboard</button>
            <button onclick="mudarAba('solicitacoes')" id="nav-solicitacoes" class="w-full text-left px-6 py-3 text-xs font-bold text-slate-400 hover:text-white transition-all"><i class="fa-solid fa-inbox w-6"></i> Solicita√ß√µes</button>
            <button onclick="mudarAba('aberto')" id="nav-aberto" class="w-full text-left px-6 py-3 text-xs font-bold text-slate-400 hover:text-white transition-all"><i class="fa-solid fa-wallet w-6"></i> Cobran√ßa Ativa</button>
            <button onclick="mudarAba('clientes')" id="nav-clientes" class="w-full text-left px-6 py-3 text-xs font-bold text-slate-400 hover:text-white transition-all"><i class="fa-solid fa-users w-6"></i> Clientes / Extrato</button>
            <button onclick="mudarAba('cadastro')" id="nav-cadastro" class="w-full text-left px-6 py-3 text-xs font-bold text-slate-400 hover:text-white transition-all"><i class="fa-solid fa-user-plus w-6"></i> Cadastro Manual</button>
            
            <p class="text-[9px] font-black text-slate-600 uppercase tracking-widest px-6 mb-2 mt-6">Administra√ß√£o</p>
            <button onclick="mudarAba('caixa')" id="nav-caixa" class="w-full text-left px-6 py-3 text-xs font-bold text-slate-400 hover:text-white transition-all"><i class="fa-solid fa-money-bill-transfer w-6"></i> Sa√≠da de Caixa</button>
            <button onclick="mudarAba('ranking')" id="nav-ranking" class="w-full text-left px-6 py-3 text-xs font-bold text-slate-400 hover:text-white transition-all"><i class="fa-solid fa-handshake w-6"></i> Promotores</button>
            <button onclick="mudarAba('relatorios')" id="nav-relatorios" class="w-full text-left px-6 py-3 text-xs font-bold text-slate-400 hover:text-white transition-all"><i class="fa-solid fa-file-invoice-dollar w-6"></i> Relat√≥rios</button>
            <button onclick="mudarAba('logs')" id="nav-logs" class="w-full text-left px-6 py-3 text-xs font-bold text-slate-400 hover:text-white transition-all"><i class="fa-solid fa-clock-rotate-left w-6"></i> Auditoria (Logs)</button>
            <button onclick="mudarAba('lista-negra')" id="nav-lista-negra" class="w-full text-left px-6 py-3 text-xs font-bold text-slate-400 hover:text-white transition-all"><i class="fa-solid fa-user-slash w-6"></i> Lista Negra</button>
            <button onclick="mudarAba('config')" id="nav-config" class="w-full text-left px-6 py-3 text-xs font-bold text-slate-400 hover:text-white transition-all"><i class="fa-solid fa-gear w-6"></i> Configura√ß√µes</button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <button onclick="logout()" class="w-full py-3 rounded-xl bg-red-500/10 text-red-500 font-bold text-xs uppercase hover:bg-red-500 hover:text-white transition-all"><i class="fa-solid fa-power-off mr-2"></i> Sair do Sistema</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 h-full overflow-y-auto p-8 relative">
        <div class="fixed top-[-20%] left-[20%] w-[500px] h-[500px] bg-blue-600 rounded-full mix-blend-multiply filter blur-[150px] opacity-10 pointer-events-none"></div>

        <!-- ABA: DASHBOARD -->
        <div id="aba-dashboard" class="aba-content">
            <h2 class="text-2xl font-black uppercase tracking-tighter mb-6"><i class="fa-solid fa-chart-pie text-blue-500 mr-2"></i> Vis√£o Geral Financeira</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="glass-card p-6 rounded-3xl border border-blue-500/50 shadow-[0_0_30px_rgba(59,130,246,0.1)] relative overflow-hidden bg-blue-600/10">
                    <div class="absolute -right-4 -bottom-4 opacity-20"><i class="fa-solid fa-piggy-bank text-8xl text-blue-400"></i></div>
                    <p class="text-[10px] font-black uppercase tracking-widest text-blue-300">Caixa P/ Emprestar</p>
                    <h3 id="dash-caixa-disponivel" class="text-4xl font-black italic tracking-tighter mt-2 text-white">R$ 0,00</h3>
                </div>
                <div class="glass-card p-6 rounded-3xl border border-orange-500/20 relative overflow-hidden">
                    <div class="absolute -right-4 -bottom-4 opacity-10"><i class="fa-solid fa-hand-holding-dollar text-8xl text-orange-500"></i></div>
                    <p class="text-[10px] font-black uppercase tracking-widest text-orange-400">Capital na Rua (Emprestado)</p>
                    <h3 id="dash-capital-rua" class="text-3xl font-black italic tracking-tighter mt-2">R$ 0,00</h3>
                </div>
                <div class="glass-card p-6 rounded-3xl border border-emerald-500/20 relative overflow-hidden">
                    <div class="absolute -right-4 -bottom-4 opacity-10"><i class="fa-solid fa-vault text-8xl text-emerald-500"></i></div>
                    <p class="text-[10px] font-black uppercase tracking-widest text-emerald-400">Recebido Hoje</p>
                    <h3 id="dash-recebido" class="text-3xl font-black italic tracking-tighter mt-2">R$ 0,00</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="glass-card p-6 rounded-3xl border border-slate-700 relative overflow-hidden">
                    <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Total com Juros (A Receber)</p>
                    <h3 id="dash-receber" class="text-2xl font-black italic tracking-tighter mt-2 text-white">R$ 0,00</h3>
                </div>
                <div class="glass-card p-6 rounded-3xl border border-slate-700 relative overflow-hidden">
                    <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Lucro Estimado</p>
                    <h3 id="dash-lucro" class="text-2xl font-black italic tracking-tighter mt-2 text-white">R$ 0,00</h3>
                </div>
                <div class="glass-card p-6 rounded-3xl border border-red-500/20 relative overflow-hidden">
                    <p class="text-[10px] font-black uppercase tracking-widest text-red-400">Contratos em Atraso</p>
                    <h3 id="dash-atrasos" class="text-2xl font-black italic tracking-tighter mt-2 text-white">0</h3>
                </div>
            </div>
            
            <div class="glass-card p-6 rounded-3xl border border-slate-700 mt-6">
                <h3 class="text-xs font-black uppercase text-slate-400 mb-4">Fluxo de Entradas (√öltimos 7 Dias)</h3>
                <canvas id="graficoDashboard" height="80"></canvas>
            </div>
        </div>

        <!-- ABA: SOLICITA√á√ïES -->
        <div id="aba-solicitacoes" class="aba-content hidden">
            <h2 class="text-2xl font-black uppercase tracking-tighter mb-6"><i class="fa-solid fa-inbox text-blue-500 mr-2"></i> Novas Solicita√ß√µes</h2>
            <div class="glass-card rounded-3xl overflow-hidden border border-slate-700">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-800/50 text-xs uppercase font-black text-slate-400 tracking-wider">
                        <tr>
                            <th class="px-6 py-4">Cliente</th>
                            <th class="px-6 py-4">CPF</th>
                            <th class="px-6 py-4">Valor Solicitado</th>
                            <th class="px-6 py-4">Plano</th>
                            <th class="px-6 py-4">Data</th>
                            <th class="px-6 py-4 text-center">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="lista-solicitacoes" class="divide-y divide-slate-800">
                        <!-- Preenchido via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ABA: COBRAN√áA ATIVA (EM ABERTO) -->
        <div id="aba-aberto" class="aba-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black uppercase tracking-tighter"><i class="fa-solid fa-wallet text-emerald-500 mr-2"></i> Cobran√ßa Ativa</h2>
                <input type="text" id="busca-aberto" placeholder="Buscar Cliente ou CPF..." class="input-dark w-64 text-sm" onkeyup="filtrarAberto()">
            </div>
            
            <div class="glass-card rounded-3xl overflow-hidden border border-slate-700">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-800/50 text-[10px] uppercase font-black text-slate-400 tracking-wider">
                        <tr>
                            <th class="px-6 py-4">Cliente</th>
                            <th class="px-6 py-4">Vencimento</th>
                            <th class="px-6 py-4">Capital</th>
                            <th class="px-6 py-4">Saldo Devedor</th>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4 text-center">Op√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="lista-aberto" class="divide-y divide-slate-800">
                        <!-- Preenchido via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ABA: CLIENTES / EXTRATO -->
        <div id="aba-clientes" class="aba-content hidden">
            <h2 class="text-2xl font-black uppercase tracking-tighter mb-6"><i class="fa-solid fa-users text-blue-500 mr-2"></i> Gest√£o de Clientes & Extrato</h2>
            
            <div class="flex gap-4 mb-6">
                <input type="text" id="extrato-busca" placeholder="Pesquisar por Nome, CPF ou WhatsApp..." class="input-dark w-80 text-center text-sm">
                <button onclick="buscarExtrato()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-6 py-2 rounded-xl shadow-lg shadow-blue-500/20"><i class="fa-solid fa-magnifying-glass"></i> Buscar Hist√≥rico</button>
            </div>

            <div id="box-extrato" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="col-span-1 glass-card p-6 rounded-3xl border border-slate-700 h-fit relative">
                    <h3 class="text-xs font-black uppercase text-slate-400 mb-4 border-b border-slate-700 pb-2">Contrato Mais Recente</h3>
                    <h2 id="ext_nome" class="text-lg font-bold text-white mb-1">...</h2>
                    <p id="ext_cpf" class="text-xs font-mono text-slate-400 mb-4">...</p>
                    <div class="space-y-2 mb-4 pb-4 border-b border-slate-700">
                        <p class="text-xs flex justify-between"><span class="text-slate-500">Score Interno:</span> <span id="ext_score" class="font-bold text-emerald-400">500</span></p>
                        <p class="text-xs flex justify-between"><span class="text-slate-500">Capital Ativo:</span> <span id="ext_capital" class="font-bold text-white">R$ 0,00</span></p>
                        <p class="text-xs flex justify-between"><span class="text-slate-500">D√≠vida Total:</span> <span id="ext_divida" class="font-bold text-red-400">R$ 0,00</span></p>
                    </div>

                    <!-- ESTAT√çSTICAS HIST√ìRICAS DO CLIENTE -->
                    <h3 class="text-[10px] font-black uppercase text-blue-400 mb-3">Hist√≥rico de Vida do Cliente</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-700 text-center">
                            <p class="text-[8px] font-black uppercase text-slate-500">Total Emprestado</p>
                            <p id="ext_vida_pego" class="text-sm font-black text-blue-400 mt-1">R$ 0,00</p>
                        </div>
                        <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-700 text-center">
                            <p class="text-[8px] font-black uppercase text-slate-500">Dias de Atraso</p>
                            <p id="ext_vida_dias" class="text-sm font-black text-orange-400 mt-1">0</p>
                        </div>
                        <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-700 text-center col-span-2">
                            <p class="text-[8px] font-black uppercase text-slate-500">Lucro com Juros e Multas</p>
                            <p id="ext_vida_multas" class="text-sm font-black text-emerald-400 mt-1">R$ 0,00</p>
                        </div>
                    </div>
                    
                    <!-- üö® BOT√ÉO PARA VER O DOSSI√ä E FOTOS NO EXTRATO -->
                    <button onclick="abrirDossieCliente()" class="w-full bg-slate-800 hover:bg-blue-600 text-blue-400 hover:text-white py-3 rounded-xl font-black uppercase text-[10px] mt-4 transition-all shadow-lg border border-blue-500/20"><i class="fa-solid fa-address-card mr-2"></i> Ver Dados e Documentos</button>
                </div>

                <div class="col-span-2 glass-card p-6 rounded-3xl border border-slate-700">
                    <h3 class="text-xs font-black uppercase text-slate-400 mb-4 border-b border-slate-700 pb-2">√öltimas Movimenta√ß√µes (Todos os Contratos)</h3>
                    <div class="overflow-y-auto max-h-[500px] pr-2">
                        <table class="w-full text-left text-xs">
                            <thead class="text-[9px] uppercase text-slate-500 sticky top-0 bg-slate-900/90 backdrop-blur">
                                <tr><th class="py-2">Data</th><th class="py-2">Evento</th><th class="py-2">Detalhes</th><th class="py-2 text-right">Valor</th></tr>
                            </thead>
                            <tbody id="lista-extrato-movimentacoes" class="divide-y divide-slate-800">
                                <!-- JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA: CADASTRO MANUAL -->
        <div id="aba-cadastro" class="aba-content hidden">
            <h2 class="text-2xl font-black uppercase tracking-tighter mb-6"><i class="fa-solid fa-user-plus text-blue-500 mr-2"></i> Cadastro Manual de Cliente</h2>
            <form id="formCadastroRapido" class="glass-card p-8 rounded-3xl space-y-6 max-w-4xl border border-slate-700">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Nome Completo</label>
                        <input type="text" id="cad_nome" class="input-dark mt-1" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">CPF</label>
                        <input type="text" id="cad_cpf" class="input-dark mt-1" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">WhatsApp</label>
                        <input type="text" id="cad_zap" class="input-dark mt-1" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 border-t border-slate-700 pt-4">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Capital Original</label>
                        <input type="number" id="cad_capital" placeholder="Ex: 500" class="input-dark mt-1" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Saldo da D√≠vida</label>
                        <input type="number" id="cad_saldo" placeholder="Ex: 650" class="input-dark mt-1 text-red-400 font-bold" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Vencimento</label>
                        <input type="date" id="cad_venc" class="input-dark mt-1" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Frequ√™ncia</label>
                        <select id="cad_freq" class="input-dark mt-1">
                            <option value="MENSAL">Mensal</option>
                            <option value="SEMANAL">Semanal</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">N¬∫ Parcelas</label>
                        <input type="number" id="cad_parcelas" value="1" min="1" class="input-dark mt-1 font-bold text-blue-400" title="1 para rolagem √∫nica, >1 para parcelado fixo">
                    </div>
                </div>

                <!-- Sec√ß√£o de Hist√≥rico Financeiro Pr√©vio (Migra√ß√£o Real) -->
                <div class="bg-blue-900/10 border border-blue-500/20 p-4 rounded-xl mt-4">
                    <h3 class="text-[10px] font-black uppercase text-blue-400 mb-3"><i class="fa-solid fa-clock-rotate-left mr-1"></i> Hist√≥rico de Pagamentos (Opcional - Migra√ß√£o)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Total de Juros/Multas J√° Pagos (R$)</label>
                            <input type="number" id="cad_juros_pagos" class="input-dark mt-1" placeholder="Ex: 150">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Total de D√≠vida (Capital) J√° Abatida (R$)</label>
                            <input type="number" id="cad_capital_pago" class="input-dark mt-1" placeholder="Ex: 0">
                        </div>
                    </div>
                    <p class="text-[9px] text-slate-500 mt-2 ml-2">Esses valores ser√£o somados ao extrato do cliente para n√£o perder o hist√≥rico de pagamentos de sistemas antigos.</p>
                </div>

                <div class="pt-4 border-t border-slate-700">
                    <label class="text-[10px] font-black uppercase text-emerald-400 mb-4 block">Documentos (Opcional)</label>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <label class="cursor-pointer bg-slate-900/50 p-4 rounded-xl border border-dashed border-slate-600 text-center hover:border-emerald-500 transition-colors">
                            <i class="fa-solid fa-user text-xl mb-2 text-slate-400"></i><p class="text-[9px] uppercase font-bold text-slate-300">Selfie</p>
                            <input type="file" id="cad_selfie" class="hidden" accept="image/*" onchange="marcarFicheiroCad(this)">
                        </label>
                        <label class="cursor-pointer bg-slate-900/50 p-4 rounded-xl border border-dashed border-slate-600 text-center hover:border-emerald-500 transition-colors">
                            <i class="fa-solid fa-id-card text-xl mb-2 text-slate-400"></i><p class="text-[9px] uppercase font-bold text-slate-300">Frente</p>
                            <input type="file" id="cad_frente" class="hidden" accept="image/*" onchange="marcarFicheiroCad(this)">
                        </label>
                        <label class="cursor-pointer bg-slate-900/50 p-4 rounded-xl border border-dashed border-slate-600 text-center hover:border-emerald-500 transition-colors">
                            <i class="fa-solid fa-id-card text-xl mb-2 text-slate-400"></i><p class="text-[9px] uppercase font-bold text-slate-300">Verso</p>
                            <input type="file" id="cad_verso" class="hidden" accept="image/*" onchange="marcarFicheiroCad(this)">
                        </label>
                        <label class="cursor-pointer bg-slate-900/50 p-4 rounded-xl border border-dashed border-slate-600 text-center hover:border-emerald-500 transition-colors">
                            <i class="fa-solid fa-file-invoice text-xl mb-2 text-slate-400"></i><p class="text-[9px] uppercase font-bold text-slate-300">Resid√™ncia</p>
                            <input type="file" id="cad_residencia" class="hidden" accept="image/*" onchange="marcarFicheiroCad(this)">
                        </label>
                        <label class="cursor-pointer bg-slate-900/50 p-4 rounded-xl border border-dashed border-slate-600 text-center hover:border-emerald-500 transition-colors">
                            <i class="fa-solid fa-house text-xl mb-2 text-slate-400"></i><p class="text-[9px] uppercase font-bold text-slate-300">Casa</p>
                            <input type="file" id="cad_casa" class="hidden" accept="image/*" onchange="marcarFicheiroCad(this)">
                        </label>
                    </div>
                </div>

                <button type="button" onclick="salvarCadastroRapido()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black uppercase py-4 rounded-xl transition-all shadow-lg shadow-blue-500/20"><i class="fa-solid fa-cloud-arrow-up mr-2"></i> Inserir no Sistema</button>
            </form>
        </div>

        <!-- ABA: SA√çDA DE CAIXA / PR√ì-LABORE -->
        <div id="aba-caixa" class="aba-content hidden">
            <h2 class="text-2xl font-black uppercase tracking-tighter mb-6"><i class="fa-solid fa-money-bill-transfer text-red-500 mr-2"></i> Sa√≠da de Caixa / Pr√≥-labore</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="col-span-1 glass-card p-6 rounded-3xl border border-slate-700 h-fit">
                    <h3 class="text-[11px] font-black uppercase text-slate-400 tracking-widest mb-4">Registrar Nova Sa√≠da</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Motivo / Descri√ß√£o</label>
                            <input type="text" id="saida_motivo" placeholder="Ex: Retirada Pr√≥-labore, Promotor..." class="input-dark mt-1">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Valor (R$)</label>
                            <input type="number" id="saida_valor" placeholder="0.00" class="input-dark mt-1 font-bold text-red-400">
                        </div>
                        <button onclick="registrarSaidaCaixa()" class="w-full bg-red-600 hover:bg-red-500 text-white font-black uppercase py-3 rounded-xl transition-all shadow-lg shadow-red-500/20 mt-2"><i class="fa-solid fa-minus-circle mr-2"></i> Lan√ßar Sa√≠da</button>
                    </div>
                </div>
                <div class="col-span-2 glass-card p-6 rounded-3xl border border-slate-700">
                    <h3 class="text-[11px] font-black uppercase text-slate-400 tracking-widest mb-4">√öltimos Lan√ßamentos (Sa√≠das)</h3>
                    <div class="overflow-hidden rounded-xl border border-slate-800">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-800/50 text-[10px] uppercase font-black text-slate-500">
                                <tr><th class="px-4 py-3">Data</th><th class="px-4 py-3">Motivo</th><th class="px-4 py-3 text-right">Valor</th></tr>
                            </thead>
                            <tbody id="lista-saidas" class="divide-y divide-slate-800">
                                <!-- JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA: PROMOTORES / RANKING -->
        <div id="aba-ranking" class="aba-content hidden">
            <h2 class="text-2xl font-black uppercase tracking-tighter mb-6"><i class="fa-solid fa-handshake text-purple-500 mr-2"></i> Gest√£o de Promotores</h2>
            <div class="glass-card p-6 rounded-3xl border border-slate-700 max-w-2xl mb-6">
                <h3 class="text-xs font-black uppercase text-slate-400 mb-4">Adicionar Novo Promotor</h3>
                <div class="flex gap-4">
                    <input type="text" id="promo_nome" placeholder="Nome do Promotor" class="input-dark w-1/2">
                    <input type="text" id="promo_cpf" placeholder="CPF" class="input-dark w-1/3">
                    <button onclick="adicionarPromotor()" class="bg-purple-600 hover:bg-purple-500 text-white font-bold px-6 py-2 rounded-xl">Adicionar</button>
                </div>
            </div>
            <div class="glass-card rounded-3xl overflow-hidden border border-slate-700">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-800/50 text-xs uppercase font-black text-slate-400 tracking-wider">
                        <tr><th class="px-6 py-4">Promotor</th><th class="px-6 py-4">CPF (C√≥digo)</th><th class="px-6 py-4">Data In√≠cio</th></tr>
                    </thead>
                    <tbody id="lista-promotores" class="divide-y divide-slate-800">
                        <!-- JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ABA: RELAT√ìRIOS -->
        <div id="aba-relatorios" class="aba-content hidden">
            <h2 class="text-2xl font-black uppercase tracking-tighter mb-6"><i class="fa-solid fa-file-invoice-dollar text-emerald-500 mr-2"></i> Relat√≥rios Financeiros</h2>
            
            <div class="glass-card p-6 rounded-3xl border border-slate-700 mb-6 flex flex-wrap gap-4 items-end justify-between">
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-2 block mb-1">Per√≠odo</label>
                        <select id="filtro-relatorio" class="input-dark w-48 text-sm" onchange="verificarFiltroData()">
                            <option value="mes">Este M√™s</option>
                            <option value="semana">Esta Semana</option>
                            <option value="semestre">Este Semestre</option>
                            <option value="ano">Este Ano</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    <div id="datas-customizadas" class="hidden flex gap-2">
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-500 ml-2 block mb-1">In√≠cio</label>
                            <input type="date" id="data_inicio_rel" class="input-dark w-36 text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-500 ml-2 block mb-1">Fim</label>
                            <input type="date" id="data_fim_rel" class="input-dark w-36 text-sm">
                        </div>
                    </div>
                    <button onclick="carregarRelatorios()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-6 py-3 rounded-xl transition-all shadow-lg"><i class="fa-solid fa-filter"></i> Gerar Relat√≥rio</button>
                </div>
                <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-4 py-2 rounded-xl transition-all"><i class="fa-solid fa-print"></i> Exportar / Imprimir</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card p-6 rounded-3xl border border-slate-700">
                    <h3 class="text-xs font-black uppercase text-slate-400 mb-4">Entradas vs Sa√≠das no Per√≠odo</h3>
                    <canvas id="graficoRelatorio1"></canvas>
                </div>
                <div class="glass-card p-6 rounded-3xl border border-slate-700">
                    <h3 class="text-xs font-black uppercase text-slate-400 mb-4">Resumo Consolidado</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between border-b border-slate-700 pb-2"><span class="text-slate-400">Total Recebido (Caixa):</span> <span id="rel_recebido" class="font-bold text-emerald-400">R$ 0,00</span></div>
                        <div class="flex justify-between border-b border-slate-700 pb-2"><span class="text-slate-400">Total de Despesas/Sa√≠das:</span> <span id="rel_saida" class="font-bold text-red-400">R$ 0,00</span></div>
                        <div class="flex justify-between border-b border-slate-700 pb-2"><span class="text-slate-400">Novos Empr√©stimos Realizados:</span> <span id="rel_emprestado" class="font-bold text-blue-400">R$ 0,00</span></div>
                        <div class="flex justify-between pt-2"><span class="text-white font-black">LUCRO L√çQUIDO DO PER√çODO:</span> <span id="rel_liquido" class="font-black text-white text-lg">R$ 0,00</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA: AUDITORIA / LOGS -->
        <div id="aba-logs" class="aba-content hidden">
            <h2 class="text-2xl font-black uppercase tracking-tighter mb-6"><i class="fa-solid fa-clock-rotate-left text-orange-500 mr-2"></i> Auditoria de Logs</h2>
            <div class="glass-card rounded-3xl overflow-hidden border border-slate-700">
                <div class="max-h-[70vh] overflow-y-auto">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-800/80 sticky top-0 text-[10px] uppercase font-black text-slate-400 tracking-wider">
                            <tr>
                                <th class="px-6 py-4">Data / Hora</th>
                                <th class="px-6 py-4">Evento</th>
                                <th class="px-6 py-4">Detalhes</th>
                                <th class="px-6 py-4 text-right">Valor Associado</th>
                            </tr>
                        </thead>
                        <tbody id="lista-todos-logs" class="divide-y divide-slate-800">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ABA: LISTA NEGRA -->
        <div id="aba-lista-negra" class="aba-content hidden">
            <h2 class="text-2xl font-black uppercase tracking-tighter mb-6"><i class="fa-solid fa-user-slash text-red-500 mr-2"></i> Lista Negra de CPFs</h2>
            <div class="glass-card p-6 rounded-3xl border border-red-500/20 max-w-4xl mb-6">
                <h3 class="text-xs font-black uppercase text-red-400 mb-4">Bloquear Novo CPF</h3>
                <div class="flex gap-4 items-end">
                    <div class="w-1/3">
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-2">CPF a Bloquear</label>
                        <input type="text" id="ln_cpf" placeholder="Apenas n√∫meros" class="input-dark mt-1">
                    </div>
                    <div class="w-1/2">
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Motivo do Bloqueio</label>
                        <input type="text" id="ln_motivo" placeholder="Ex: Fraude, Inadimplente, Calote..." class="input-dark mt-1">
                    </div>
                    <button onclick="adicionarListaNegra()" class="bg-red-600 hover:bg-red-500 text-white font-bold px-6 py-3 rounded-xl mb-[2px]">Bloquear CPF</button>
                </div>
            </div>
            <div class="glass-card rounded-3xl overflow-hidden border border-slate-700">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-800/50 text-xs uppercase font-black text-slate-400 tracking-wider">
                        <tr><th class="px-6 py-4">CPF Bloqueado</th><th class="px-6 py-4">Motivo / Detalhes</th><th class="px-6 py-4">Data Inclus√£o</th><th class="px-6 py-4 text-center">A√ß√£o</th></tr>
                    </thead>
                    <tbody id="lista-negra-body" class="divide-y divide-slate-800">
                        <!-- JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ABA: CONFIGURA√á√ïES -->
        <div id="aba-config" class="aba-content hidden">
            <h2 class="text-2xl font-black uppercase tracking-tighter mb-6"><i class="fa-solid fa-gear text-slate-400 mr-2"></i> Configura√ß√µes do Sistema</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card p-6 rounded-3xl border border-slate-700 space-y-4">
                    
                    <h3 class="text-xs font-black uppercase text-blue-400 mb-2 border-b border-slate-700 pb-2">Controlo do Cofre (Capital da Empresa)</h3>
                    <div class="mb-4">
                        <label class="text-[10px] font-black uppercase text-emerald-500 ml-2">Tamanho do Caixa Geral (R$)</label>
                        <input type="number" id="conf_caixa_total" class="input-dark mt-1 border border-emerald-500/30 shadow-[0_0_10px_rgba(16,185,129,0.1)]" placeholder="Ex: 50000">
                        <p class="text-[9px] text-slate-500 mt-1 ml-2">Este valor ser√° usado para calcular o quanto tem dispon√≠vel para emprestar no Dashboard.</p>
                    </div>

                    <h3 class="text-xs font-black uppercase text-blue-400 mb-4 border-b border-slate-700 pb-2 mt-6">Par√¢metros Financeiros</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Juros √önica Parcela (%)</label>
                            <input type="number" id="conf_juros_unico" class="input-dark mt-1" placeholder="Ex: 30">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Juros Parcelado (%)</label>
                            <input type="number" id="conf_juros_parcelado" class="input-dark mt-1" placeholder="Ex: 25">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Multa Di√°ria Atraso (%)</label>
                        <input type="number" id="conf_multa" class="input-dark mt-1">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Valor M√≠nimo para Cr√©dito (R$)</label>
                        <input type="number" id="conf_minimo" class="input-dark mt-1" placeholder="Ex: 500">
                    </div>
                    <button onclick="salvarConfig()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black uppercase py-3 rounded-xl shadow-lg mt-4"><i class="fa-solid fa-save mr-2"></i> Guardar Altera√ß√µes</button>
                </div>
            </div>
        </div>

    </main>

    <!-- MODAIS -->

    <!-- Modal: Documentos Completos e Contra-Proposta -->
    <div id="modalDocumentos" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-6xl max-h-[95vh] overflow-y-auto rounded-3xl border border-slate-700 p-8 relative">
            <button onclick="fecharModal('modalDocumentos')" class="absolute top-6 right-6 text-slate-400 hover:text-white text-2xl"><i class="fa-solid fa-xmark"></i></button>
            
            <div class="border-b border-slate-800 pb-4 mb-6 flex justify-between items-end">
                <div>
                    <h2 class="text-2xl font-black uppercase text-blue-500">Documentos e An√°lise</h2>
                    <p id="docNomeCliente" class="text-lg text-white font-bold mt-1">...</p>
                    <p id="docCpf" class="text-xs font-mono text-slate-400">...</p>
                    <p id="docNumContrato" class="text-[10px] text-emerald-400 font-bold hidden mt-1">Contrato: <span></span></p> 
                </div>
                <div class="text-right">
                    <p id="docData" class="text-xs font-bold text-slate-500 uppercase">...</p>
                    <p class="text-[10px] mt-1 text-emerald-400 font-black"><i class="fa-solid fa-location-dot"></i> GPS Capturado</p>
                </div>
            </div>

            <!-- Grade de 5 Fotos -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="space-y-2"><p class="text-[10px] font-black uppercase text-center text-slate-400">Selfie</p><div class="bg-slate-900/50 rounded-xl border border-slate-600 hover:border-blue-500 p-1"><img id="imgSelfie" class="w-full h-32 object-contain cursor-pointer transition-colors" onclick="zoomImg(this.src)"></div></div>
                <div class="space-y-2"><p class="text-[10px] font-black uppercase text-center text-slate-400">Doc. Frente</p><div class="bg-slate-900/50 rounded-xl border border-slate-600 hover:border-blue-500 p-1"><img id="imgFrente" class="w-full h-32 object-contain cursor-pointer transition-colors" onclick="zoomImg(this.src)"></div></div>
                <div class="space-y-2"><p class="text-[10px] font-black uppercase text-center text-slate-400">Doc. Verso</p><div class="bg-slate-900/50 rounded-xl border border-slate-600 hover:border-blue-500 p-1"><img id="imgVerso" class="w-full h-32 object-contain cursor-pointer transition-colors" onclick="zoomImg(this.src)"></div></div>
                <div class="space-y-2"><p class="text-[10px] font-black uppercase text-center text-slate-400">Resid√™ncia</p><div class="bg-slate-900/50 rounded-xl border border-slate-600 hover:border-blue-500 p-1"><img id="imgResidencia" class="w-full h-32 object-contain cursor-pointer transition-colors" onclick="zoomImg(this.src)"></div></div>
                <div class="space-y-2 col-span-2 md:col-span-1"><p class="text-[10px] font-black uppercase text-center text-slate-400">Fachada Casa</p><div class="bg-slate-900/50 rounded-xl border border-slate-600 hover:border-blue-500 p-1"><img id="imgCasa" class="w-full h-32 object-contain cursor-pointer transition-colors" onclick="zoomImg(this.src)"></div></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-900/50 p-5 rounded-2xl border border-slate-700">
                    <h3 class="text-[10px] font-black uppercase text-blue-400 mb-3">Dados Cadastrais</h3>
                    <div class="space-y-2 text-xs">
                        <p class="flex justify-between"><span class="text-slate-500">WhatsApp:</span> <span id="docZap" class="font-bold text-white"></span></p>
                        <p class="flex justify-between"><span class="text-slate-500">Valor Pedido:</span> <span id="docValor" class="font-bold text-emerald-400"></span></p>
                        <p class="flex justify-between"><span class="text-slate-500">Plano / Freq:</span> <span id="docPlano" class="font-bold text-white"></span></p>
                        <p class="flex justify-between"><span class="text-slate-500">Promotor:</span> <span id="docIndicacao" class="font-bold text-purple-400"></span></p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-800 space-y-2 text-xs">
                        <p class="text-[9px] font-black uppercase text-slate-500">Refer√™ncias</p>
                        <p>1: <span id="docRef1" class="font-bold text-white"></span></p>
                        <p>2: <span id="docRef2" class="font-bold text-white"></span></p>
                    </div>
                </div>

                <div class="bg-slate-900/50 p-5 rounded-2xl border border-slate-700 flex flex-col">
                    <h3 class="text-[10px] font-black uppercase text-orange-400 mb-2">Observa√ß√µes / Auditoria</h3>
                    <textarea id="docObs" class="input-dark flex-1 resize-none text-sm" placeholder="Adicione notas sobre o perfil do cliente, restri√ß√µes encontradas, etc..."></textarea>
                </div>

                <div class="bg-slate-900/50 p-5 rounded-2xl border border-slate-700 flex flex-col justify-between" id="box-simulador-cp">
                    <h3 class="text-[10px] font-black uppercase text-emerald-400 mb-3 border-b border-slate-700 pb-2">Simulador & Contra-Proposta</h3>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="text-[9px] font-black uppercase text-slate-500 block mb-1">Valor Aprovado (R$)</label>
                            <input type="number" id="docNovoValor" class="input-dark text-sm font-bold text-emerald-400" oninput="recalcularSimulacao()">
                        </div>
                        <div>
                            <label class="text-[9px] font-black uppercase text-slate-500 block mb-1">Juros (%)</label>
                            <input type="number" id="docJuros" class="input-dark text-sm font-bold" oninput="recalcularSimulacao()">
                        </div>
                        <div>
                            <label class="text-[9px] font-black uppercase text-slate-500 block mb-1">Frequ√™ncia</label>
                            <select id="docNovaFreq" class="input-dark text-xs p-2 h-11" onchange="recalcularSimulacao()">
                                <option value="MENSAL">Mensal</option>
                                <option value="SEMANAL">Semanal</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[9px] font-black uppercase text-slate-500 block mb-1">N¬∫ Parcelas</label>
                            <input type="number" id="docNovasParcelas" class="input-dark text-sm font-bold" min="1" oninput="recalcularSimulacao()">
                        </div>
                    </div>

                    <div class="bg-slate-800/80 p-4 rounded-xl border border-slate-600 mb-4 shadow-inner">
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Valor da Parcela:</span>
                            <span id="calcParcela" class="text-sm font-black text-blue-400 drop-shadow-[0_0_5px_rgba(59,130,246,0.3)]">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Total c/ Juros:</span>
                            <span id="calcTotal" class="text-lg font-black text-emerald-400 drop-shadow-[0_0_5px_rgba(16,185,129,0.3)]">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="space-y-2 mt-auto">
                        <button onclick="aprovarSolicitacao(false)" id="btnAprovarOriginal" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-black uppercase text-[10px] shadow-lg shadow-blue-500/20 transition-all"><i class="fa-solid fa-check-double mr-1"></i> Aprovar Termos Originais</button>
                        <button onclick="aprovarSolicitacao(true)" id="btnAprovarCP" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-black uppercase text-[10px] shadow-lg shadow-emerald-500/20 transition-all"><i class="fa-solid fa-handshake mr-1"></i> Enviar Contra-Proposta</button>
                        <button onclick="rejeitarSolicitacao()" class="w-full bg-slate-800 hover:bg-red-600 text-slate-300 hover:text-white py-3 rounded-xl font-black uppercase text-[10px] transition-all"><i class="fa-solid fa-xmark mr-1"></i> Rejeitar Ficha</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Imagem Fullscreen -->
    <div id="modalZoom" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center p-4 cursor-pointer" onclick="this.classList.add('hidden')">
        <img id="zoomSource" src="" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl">
    </div>

    <!-- Modal: Registrar Pagamento -->
    <div id="modalPagamento" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md rounded-3xl border border-slate-700 p-8 relative">
            <button onclick="fecharModal('modalPagamento')" class="absolute top-6 right-6 text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            <h2 class="text-xl font-black uppercase text-emerald-500 mb-2">Registrar Pagamento</h2>
            <p class="text-[10px] font-bold text-slate-400 uppercase mb-6 leading-tight">Pagamentos menores que o valor total da d√≠vida ser√£o processados automaticamente como <span class="text-blue-400">Pagamento Parcial</span>.</p>
            <input type="hidden" id="pgtoDevedorId">
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Valor Recebido (R$)</label>
                    <input type="number" id="pgtoValor" class="input-dark mt-1 font-bold text-emerald-400 text-lg">
                </div>
                <button onclick="confirmarPagamento()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-black uppercase text-sm shadow-lg shadow-emerald-500/20">Confirmar Baixa de Valor</button>
            </div>
        </div>
    </div>

    <!-- Modal: Edi√ß√£o de Contrato -->
    <div id="modalEditarContrato" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-lg rounded-3xl border border-slate-700 p-8 relative">
            <button onclick="fecharModal('modalEditarContrato')" class="absolute top-6 right-6 text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            <h2 class="text-xl font-black uppercase text-blue-500 mb-6"><i class="fa-solid fa-pen-to-square mr-2"></i> Editar Contrato em Aberto</h2>
            <input type="hidden" id="editDevedorId">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Novo Vencimento</label>
                    <input type="date" id="editVencimento" class="input-dark mt-1 text-sm font-bold text-white">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Frequ√™ncia</label>
                    <select id="editFrequencia" class="input-dark mt-1 text-sm">
                        <option value="MENSAL">Mensal</option>
                        <option value="SEMANAL">Semanal</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Capital Original (R$)</label>
                    <input type="number" id="editCapital" class="input-dark mt-1 font-bold text-white">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Saldo Devedor Atual (R$)</label>
                    <input type="number" id="editTotal" class="input-dark mt-1 font-bold text-red-400">
                </div>
            </div>
            <button onclick="salvarEdicaoContrato()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-black uppercase text-sm shadow-lg shadow-blue-500/20">Salvar Altera√ß√µes</button>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin; 
        let solicitacaoAtualId = null;
        let listaDevedoresAtuais = [];
        let chartInstanceDash = null;
        let chartInstanceRel = null;

        const token = localStorage.getItem('token');
        const headersAuth = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };

        // Preven√ß√£o XSS
        function escapeHTML(str) {
            if (!str) return '';
            return String(str).replace(/[&<>'"]/g, tag => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
            }[tag] || tag));
        }

        async function initApp() {
            if (!token && window.location.hostname !== 'localhost') return logout();
            
            // Carrega a tela primeiro para n√£o dar impress√£o de tela travada
            mudarAba('dashboard');
            carregarConfig(); 

            try {
                // Valida a sess√£o de forma ass√≠ncrona (n√£o bloqueia a tela)
                const res = await fetch(`${API_BASE}/api/verify-session`, { headers: headersAuth });
                
                if (res.status === 401) {
                    // O servidor rejeitou expressamente o token
                    showToast("Sess√£o expirada. Fa√ßa login novamente.", "error");
                    setTimeout(logout, 2000);
                }
            } catch (error) {
                // Se der erro de fetch (ex: Node a reiniciar), N√ÉO desloga, apenas ignora.
                console.warn("Servidor offline temporariamente. Sess√£o mantida localmente.");
            }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            document.getElementById('toastIcon').className = type === 'success' ? 'fa-solid fa-circle-check text-emerald-500' : 'fa-solid fa-triangle-exclamation text-red-500';
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }

        function mudarAba(aba) {
            document.querySelectorAll('.aba-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('tab-active'));
            document.getElementById(`aba-${aba}`).classList.remove('hidden');
            document.getElementById(`nav-${aba}`).classList.add('tab-active');
            
            if (aba === 'dashboard') carregarDash();
            if (aba === 'solicitacoes') carregarSoli();
            if (aba === 'aberto') carregarAberto();
            if (aba === 'caixa') carregarSaidas();
            if (aba === 'ranking') carregarPromotores();
            if (aba === 'logs') carregarTodosLogs();
            if (aba === 'lista-negra') carregarListaNegra();
            if (aba === 'relatorios') carregarRelatorios();
            if (aba === 'config') carregarConfig();
        }

        function fecharModal(id) { document.getElementById(id).classList.add('hidden'); }
        function zoomImg(src) { document.getElementById('zoomSource').src = src; document.getElementById('modalZoom').classList.remove('hidden'); }
        function logout() { localStorage.removeItem('token'); window.location.href = '/login.html'; }

        // =====================================
        // DASHBOARD & GR√ÅFICOS
        // =====================================
        async function carregarDash() {
            try {
                const res = await fetch(`${API_BASE}/api/dashboard`, { headers: headersAuth });
                const data = await res.json();
                
                const receber = parseFloat(data.totalAReceber) || 0;
                const recebido = parseFloat(data.recebidoHoje) || 0;
                const lucro = parseFloat(data.lucroEstimado) || 0;
                const atrasos = parseInt(data.pendencias) || 0;
                const capitalNaRua = parseFloat(data.capitalNaRua) || 0;
                const caixaDisponivel = parseFloat(data.caixaDisponivel) || 0;

                document.getElementById('dash-receber').innerText = receber.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('dash-recebido').innerText = recebido.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('dash-lucro').innerText = lucro.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('dash-atrasos').innerText = atrasos;
                document.getElementById('dash-capital-rua').innerText = capitalNaRua.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('dash-caixa-disponivel').innerText = caixaDisponivel.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

                // Busca logs para desenhar o gr√°fico com dados REAIS
                const resLogs = await fetch(`${API_BASE}/api/logs-auditoria`, { headers: headersAuth });
                const logsReais = resLogs.ok ? await resLogs.json() : [];

                renderizarGraficoDash(logsReais);
            } catch (e) { console.error("Erro Dash", e); }
        }

        function renderizarGraficoDash(logs) {
            // Algoritmo para agrupar os recebimentos dos √∫ltimos 7 dias
            const ultimos7Dias = [];
            const labels = [];
            const hoje = new Date();
            hoje.setHours(0,0,0,0);

            // Varre de 6 dias atr√°s at√© hoje
            for (let i = 6; i >= 0; i--) {
                const d = new Date(hoje);
                d.setDate(d.getDate() - i);
                
                // Formata o dia (Ex: 'Seg', 'Ter')
                labels.push(d.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', ''));
                
                // Soma todos os logs de fluxo financeiro positivo que ocorreram neste dia espec√≠fico
                const somaDia = logs.filter(l => {
                    const dataLog = new Date(l.created_at);
                    const isMesmoDia = dataLog.getDate() === d.getDate() && dataLog.getMonth() === d.getMonth();
                    const valor = parseFloat(l.valor_fluxo) || 0;
                    return isMesmoDia && valor > 0;
                }).reduce((acc, l) => acc + parseFloat(l.valor_fluxo), 0);
                
                ultimos7Dias.push(somaDia);
            }

            const ctx = document.getElementById('graficoDashboard').getContext('2d');
            if (chartInstanceDash) chartInstanceDash.destroy();
            chartInstanceDash = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Entradas de Caixa (R$)',
                        data: ultimos7Dias,
                        borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderWidth: 2, tension: 0.4, fill: true
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { color: 'rgba(255,255,255,0.05)' } } } }
            });
        }

        // =====================================
        // SOLICITA√á√ïES E DOCUMENTOS
        // =====================================
        async function carregarSoli() {
            try {
                const res = await fetch(`${API_BASE}/api/solicitacoes-pendentes?t=${Date.now()}`, { headers: headersAuth });
                const lista = await res.json();
                const tbody = document.getElementById('lista-solicitacoes');
                tbody.innerHTML = '';
                lista.forEach(s => {
                    const valor = parseFloat(s.valor) || 0;
                    tbody.innerHTML += `
                        <tr id="tr-soli-${s.id}" class="hover:bg-slate-800/50 transition-colors">
                            <td class="px-6 py-4 font-bold text-white">${escapeHTML(s.nome)}</td>
                            <td class="px-6 py-4 font-mono text-slate-400">${escapeHTML(s.cpf)}</td>
                            <td class="px-6 py-4 text-emerald-400 font-bold">${valor.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                            <td class="px-6 py-4 text-slate-300 text-xs">${escapeHTML(s.tipo_plano)}</td>
                            <td class="px-6 py-4 text-slate-500 text-xs">${new Date(s.created_at).toLocaleDateString()}</td>
                            <td class="px-6 py-4 text-center">
                                <button onclick='abrirDocumentos(${JSON.stringify(s).replace(/'/g, "&#39;")})' class="bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white px-4 py-2 rounded-lg text-xs font-bold transition-colors">Ver Documentos</button>
                            </td>
                        </tr>
                    `;
                });
            } catch(e) {}
        }

        function recalcularSimulacao() {
            const valor = parseFloat(document.getElementById('docNovoValor').value) || 0;
            const juros = parseFloat(document.getElementById('docJuros').value) || 0;
            const parcelas = parseInt(document.getElementById('docNovasParcelas').value) || 1;
            
            const total = valor * (1 + (juros / 100));
            const valorParcela = total / parcelas;

            document.getElementById('calcTotal').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('calcParcela').innerText = valorParcela.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        }

        function abrirDocumentos(s) {
            solicitacaoAtualId = s.id;
            document.getElementById('docNomeCliente').textContent = s.nome;
            document.getElementById('docCpf').textContent = s.cpf;
            document.getElementById('docData').innerText = new Date(s.created_at).toLocaleString();
            document.getElementById('docNumContrato').classList.add('hidden'); 
            
            const valor = parseFloat(s.valor) || 0;
            const qtdParcelas = parseInt(s.qtd_parcelas) || 1;
            const jurosPadrao = qtdParcelas > 1 ? (window.sistemaConfig?.juros_parcelado || 25) : (window.sistemaConfig?.juros_unico || 30);

            document.getElementById('docValor').innerText = valor.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('docZap').textContent = s.whatsapp || 'N√£o informado';
            document.getElementById('docPlano').textContent = `${s.tipo_plano} / ${s.frequencia} / ${qtdParcelas}x`;
            document.getElementById('docIndicacao').textContent = s.indicado_por || 'DIRETO';
            document.getElementById('docRef1').textContent = `${s.referencia1_nome || 'N/A'} - ${s.referencia1_tel || ''}`;
            document.getElementById('docRef2').textContent = `${s.referencia2_nome || 'N/A'} - ${s.referencia2_tel || ''}`;
            document.getElementById('docObs').value = s.observacoes || "";
            document.getElementById('docObs').readOnly = false; 

            document.getElementById('docNovoValor').dataset.original = valor;
            document.getElementById('docJuros').dataset.original = jurosPadrao;
            document.getElementById('docNovaFreq').dataset.original = s.frequencia || 'MENSAL';
            document.getElementById('docNovasParcelas').dataset.original = qtdParcelas;

            document.getElementById('docNovoValor').value = valor;
            document.getElementById('docNovaFreq').value = s.frequencia || 'MENSAL';
            document.getElementById('docNovasParcelas').value = qtdParcelas;
            document.getElementById('docJuros').value = jurosPadrao;

            recalcularSimulacao();

            const p = "https://via.placeholder.com/300x200?text=Sem+Foto";
            document.getElementById('imgSelfie').src = s.url_selfie || p;
            document.getElementById('imgFrente').src = s.url_frente || s.url_documento || p; 
            document.getElementById('imgVerso').src = s.url_verso || p;
            document.getElementById('imgResidencia').src = s.url_residencia || p;
            document.getElementById('imgCasa').src = s.url_casa || p;

            document.getElementById('box-simulador-cp').classList.remove('hidden');
            document.getElementById('modalDocumentos').classList.remove('hidden');
        }

        // =====================================
        // MODO LEITURA DE DOSSI√ä (EXTRATO)
        // =====================================
        function abrirDossieCliente() {
            if(!window.clienteAtualExtrato) return showToast("Selecione um cliente primeiro.", "error");
            const c = window.clienteAtualExtrato;
            
            document.getElementById('docNomeCliente').textContent = c.nome;
            document.getElementById('docCpf').textContent = c.cpf;
            document.getElementById('docData').innerText = new Date(c.created_at).toLocaleString();
            
            const valor = parseFloat(c.valor_emprestado) || 0;
            document.getElementById('docValor').innerText = valor.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('docZap').textContent = c.telefone || 'N√£o informado';
            document.getElementById('docPlano').textContent = `${c.tipo_plano || 'N/A'} / ${c.frequencia} / ${c.qtd_parcelas || 1}x`;
            document.getElementById('docIndicacao').textContent = c.indicado_por || 'DIRETO';
            document.getElementById('docRef1').textContent = `${c.referencia1_nome || 'N/A'} - ${c.referencia1_tel || ''}`;
            document.getElementById('docRef2').textContent = `${c.referencia2_nome || 'N/A'} - ${c.referencia2_tel || ''}`;
            
            document.getElementById('docObs').value = c.observacoes || "Nenhuma observa√ß√£o registada na proposta original.";
            document.getElementById('docObs').readOnly = true; 

            const p = "https://via.placeholder.com/300x200?text=Sem+Foto";
            document.getElementById('imgSelfie').src = c.url_selfie || p;
            document.getElementById('imgFrente').src = c.url_frente || p; 
            document.getElementById('imgVerso').src = c.url_verso || p;
            document.getElementById('imgResidencia').src = c.url_residencia || p;
            document.getElementById('imgCasa').src = c.url_casa || p;

            document.getElementById('docNumContrato').classList.remove('hidden');
            document.getElementById('docNumContrato').innerHTML = `Contrato ID: <span class="text-white">${c.uuid || c.id}</span>`;

            document.getElementById('box-simulador-cp').classList.add('hidden');
            document.getElementById('modalDocumentos').classList.remove('hidden');
        }

        async function aprovarSolicitacao(isContraProposta) {
            const btn = isContraProposta ? document.getElementById('btnAprovarCP') : document.getElementById('btnAprovarOriginal');
            const btnOriginalText = btn.innerHTML;
            
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Processando...`;
            btn.disabled = true;

            let juros, novoValor, novaFreq, novasParcelas;

            if (isContraProposta) {
                juros = document.getElementById('docJuros').value;
                novoValor = document.getElementById('docNovoValor').value;
                novaFreq = document.getElementById('docNovaFreq').value;
                novasParcelas = document.getElementById('docNovasParcelas').value;
            } else {
                juros = document.getElementById('docJuros').dataset.original;
                novoValor = document.getElementById('docNovoValor').dataset.original;
                novaFreq = document.getElementById('docNovaFreq').dataset.original;
                novasParcelas = document.getElementById('docNovasParcelas').dataset.original;
            }

            const obs = document.getElementById('docObs').value;

            try {
                const res = await fetch(`${API_BASE}/api/aprovar-solicitacao`, {
                    method: 'POST', headers: headersAuth,
                    body: JSON.stringify({ 
                        id: solicitacaoAtualId, juros: parseFloat(juros), observacao: obs,
                        novoValor: parseFloat(novoValor), novaFreq: novaFreq, novasParcelas: parseInt(novasParcelas)
                    })
                });
                
                const data = await res.json();
                
                if(res.ok) { 
                    showToast(isContraProposta ? "Contra-Proposta enviada ao cliente!" : "Proposta aprovada com sucesso!"); 
                    const tr = document.getElementById(`tr-soli-${solicitacaoAtualId}`);
                    if(tr) tr.remove();
                    fecharModal('modalDocumentos'); 
                    carregarAberto(); 
                    mudarAba('aberto'); 
                } else {
                    throw new Error(data.erro || "Erro interno do servidor.");
                }
            } catch(e) { showToast(e.message, "error"); } finally { btn.innerHTML = btnOriginalText; btn.disabled = false; }
        }

        async function rejeitarSolicitacao() {
            if(!confirm("Tem certeza que deseja rejeitar esta solicita√ß√£o?")) return;
            const obs = document.getElementById('docObs').value;
            try {
                const res = await fetch(`${API_BASE}/api/rejeitar-solicitacao`, {
                    method: 'POST', headers: headersAuth,
                    body: JSON.stringify({ id: solicitacaoAtualId, motivo: obs })
                });
                if(res.ok) { 
                    showToast("Solicita√ß√£o Rejeitada."); 
                    const tr = document.getElementById(`tr-soli-${solicitacaoAtualId}`);
                    if(tr) tr.remove();
                    fecharModal('modalDocumentos'); 
                }
            } catch(e) { showToast("Erro ao rejeitar.", "error"); }
        }

        // =====================================
        // COBRAN√áA ATIVA, PAGAMENTOS E EDI√á√ÉO
        // =====================================
        async function carregarAberto() {
            try {
                const res = await fetch(`${API_BASE}/api/devedores-ativos`, { headers: headersAuth });
                listaDevedoresAtuais = await res.json();
                renderizarAberto(listaDevedoresAtuais);
            } catch(e) {}
        }

        function renderizarAberto(lista) {
            const tbody = document.getElementById('lista-aberto');
            tbody.innerHTML = '';
            lista.forEach(d => {
                const capital = parseFloat(d.valor_emprestado) || 0;
                const total = parseFloat(d.valor_total) || 0;
                let dt = new Date(d.data_vencimento + 'T12:00:00Z');
                let hoje = new Date(); hoje.setHours(0,0,0,0);
                
                let badge = "";
                if (d.status === 'APROVADO_AGUARDANDO_ACEITE') {
                    badge = '<span class="bg-blue-500/20 text-blue-400 px-2 py-1 rounded text-[9px] font-black">ASSINATURA PENDENTE</span>';
                } else {
                    badge = dt < hoje ? '<span class="bg-red-500/20 text-red-500 px-2 py-1 rounded text-[9px] font-black">ATRASADO</span>' : '<span class="bg-emerald-500/20 text-emerald-500 px-2 py-1 rounded text-[9px] font-black">EM DIA</span>';
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-800/30 transition-colors border-b border-slate-800/50">
                        <td class="px-6 py-4"><p class="font-bold text-white text-xs">${escapeHTML(d.nome)}</p><p class="text-[9px] font-mono text-slate-500">${escapeHTML(d.cpf)}</p></td>
                        <td class="px-6 py-4 text-xs text-slate-300 font-bold">${dt.toLocaleDateString('pt-BR')}</td>
                        <td class="px-6 py-4 text-xs text-slate-400">${capital.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                        <td class="px-6 py-4 text-sm font-black text-red-400">${total.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                        <td class="px-6 py-4">${badge}</td>
                        <td class="px-6 py-4 text-center relative">
                            <button onclick="toggleDropdown('menu-${d.id}')" class="text-slate-400 hover:text-white p-2 rounded hover:bg-slate-700 transition-colors"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            <div id="menu-${d.id}" class="dropdown-menu absolute right-8 top-10 w-48 bg-slate-800 border border-slate-700 rounded-xl shadow-2xl overflow-hidden z-[60]">
                                <button onclick="prepararPagamento('${d.id}')" class="w-full text-left px-4 py-3 text-[10px] font-bold uppercase hover:bg-slate-700 text-emerald-400"><i class="fa-solid fa-money-bill-wave mr-2"></i> Receber Pgto</button>
                                <button onclick="enviarCobrancaManual('${d.id}')" class="w-full text-left px-4 py-3 text-[10px] font-bold uppercase hover:bg-slate-700 text-green-400"><i class="fa-solid fa-paper-plane mr-2"></i> Enviar Link Pgto</button>
                                <button onclick='abrirEdicaoContrato(${JSON.stringify(d).replace(/'/g, "&#39;")})' class="w-full text-left px-4 py-3 text-[10px] font-bold uppercase hover:bg-slate-700 text-orange-400"><i class="fa-solid fa-pen-to-square mr-2"></i> Editar Contrato</button>
                                <button onclick="abrirExtratoListagem('${d.cpf}')" class="w-full text-left px-4 py-3 text-[10px] font-bold uppercase hover:bg-slate-700 text-blue-400"><i class="fa-solid fa-file-invoice mr-2"></i> Ver Extrato</button>
                                <button onclick="window.open('https://wa.me/55${(d.telefone||'').replace(/\D/g,'')}', '_blank')" class="w-full text-left px-4 py-3 text-[10px] font-bold uppercase hover:bg-slate-700 text-slate-300"><i class="fa-brands fa-whatsapp mr-2"></i> WhatsApp</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.relative')) document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
        });
        function toggleDropdown(id) {
            document.querySelectorAll('.dropdown-menu').forEach(m => { if(m.id !== id) m.classList.remove('show') });
            document.getElementById(id).classList.toggle('show');
        }
        function filtrarAberto() {
            const t = document.getElementById('busca-aberto').value.toLowerCase();
            renderizarAberto(listaDevedoresAtuais.filter(d => d.nome.toLowerCase().includes(t) || d.cpf.includes(t)));
        }

        function prepararPagamento(id) {
            document.getElementById('pgtoDevedorId').value = id; document.getElementById('pgtoValor').value = '';
            document.getElementById(`menu-${id}`).classList.remove('show'); document.getElementById('modalPagamento').classList.remove('hidden');
        }

        async function confirmarPagamento() {
            const id = document.getElementById('pgtoDevedorId').value;
            const v = parseFloat(document.getElementById('pgtoValor').value);
            if(!v) return showToast("Informe o valor", "error");
            try {
                const res = await fetch(`${API_BASE}/api/baixar-manual`, { method: 'POST', headers: headersAuth, body: JSON.stringify({ id, valorPago: v }) });
                if(res.ok) { showToast("Pagamento Registrado!"); fecharModal('modalPagamento'); carregarAberto(); carregarDash(); }
            } catch(e) { showToast("Erro no servidor", "error"); }
        }

        // Fun√ß√£o para disparar a cobran√ßa via WhatsApp
        async function enviarCobrancaManual(id) {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            showToast("A processar envio...", "success");
            try {
                const res = await fetch(`${API_BASE}/api/enviar-cobranca-manual`, {
                    method: 'POST', headers: headersAuth, body: JSON.stringify({ id })
                });
                if(res.ok) showToast("Link de cobran√ßa enviado com sucesso!");
                else throw new Error();
            } catch(e) {
                showToast("Falha ao enviar a cobran√ßa.", "error");
            }
        }

        function abrirEdicaoContrato(dev) {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            document.getElementById('editDevedorId').value = dev.id;
            document.getElementById('editVencimento').value = dev.data_vencimento;
            document.getElementById('editFrequencia').value = dev.frequencia || 'MENSAL';
            document.getElementById('editCapital').value = dev.valor_emprestado;
            document.getElementById('editTotal').value = dev.valor_total;
            document.getElementById('modalEditarContrato').classList.remove('hidden');
        }

        async function salvarEdicaoContrato() {
            const id = document.getElementById('editDevedorId').value;
            const novoVenc = document.getElementById('editVencimento').value;
            const novaFreq = document.getElementById('editFrequencia').value;
            const novoCap = parseFloat(document.getElementById('editCapital').value);
            const novoTot = parseFloat(document.getElementById('editTotal').value);

            try {
                const res = await fetch(`${API_BASE}/api/editar-contrato`, { 
                    method: 'POST', headers: headersAuth, 
                    body: JSON.stringify({ id, novoVencimento: novoVenc, novoCapital: novoCap, novoTotal: novoTot, novaFrequencia: novaFreq }) 
                });
                if(res.ok) { showToast("Contrato atualizado com sucesso!"); fecharModal('modalEditarContrato'); carregarAberto(); }
            } catch(e) { showToast("Erro ao editar", "error"); }
        }

        // =====================================
        // GEST√ÉO DE CLIENTES & EXTRATO COM BUSCA FLEX√çVEL
        // =====================================
        function abrirExtratoListagem(cpf) {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            mudarAba('clientes');
            document.getElementById('extrato-busca').value = cpf;
            buscarExtrato();
        }

        async function buscarExtrato() {
            const busca = document.getElementById('extrato-busca').value.trim();
            if(busca.length < 3) return showToast("Digite pelo menos 3 caracteres para buscar", "error");
            
            try {
                // üö® CORRE√á√ÉO: Envia a busca gen√©rica para o backend
                const res = await fetch(`${API_BASE}/api/cliente-extrato/${encodeURIComponent(busca)}`, { headers: headersAuth });
                if(!res.ok) throw new Error();
                const data = await res.json();
                
                window.clienteAtualExtrato = data.cliente;
                
                document.getElementById('box-extrato').classList.remove('hidden');
                document.getElementById('ext_nome').innerText = data.cliente.nome;
                document.getElementById('ext_cpf').innerText = data.cliente.cpf;
                document.getElementById('ext_score').innerText = data.cliente.score || 500;
                
                const capital = parseFloat(data.cliente.valor_emprestado) || 0;
                const total = parseFloat(data.cliente.valor_total) || 0;
                
                document.getElementById('ext_capital').innerText = capital.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                document.getElementById('ext_divida').innerText = total.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                
                let totalPegoVida = 0;
                let diasAtrasoVida = 0;
                let valorMultasPagas = 0;

                (data.todos_contratos || []).forEach(c => {
                    totalPegoVida += (parseFloat(c.valor_emprestado) || 0);
                });

                const tbody = document.getElementById('lista-extrato-movimentacoes');
                tbody.innerHTML = '';
                if(data.logs && data.logs.length > 0) {
                    data.logs.forEach(l => {
                        const val = parseFloat(l.valor_fluxo) || 0;
                        let corValor = val > 0 ? "text-emerald-400" : (val < 0 ? "text-red-400" : "text-slate-500");
                        
                        if(l.evento.includes('Atraso')) {
                            diasAtrasoVida++;
                        }
                        
                        // Conta multas e os novos juros inseridos via migra√ß√£o
                        if(l.evento.includes('Atraso') || l.evento.includes('Recebimento (Migra√ß√£o)') || l.evento.includes('Rolagem')) {
                             const matchMulta = l.detalhes.match(/R\$\s?([\d.,]+)/);
                             if(matchMulta) {
                                 const parseMulta = parseFloat(matchMulta[1].replace(',', '.'));
                                 if(parseMulta) valorMultasPagas += parseMulta;
                             }
                             if(val > 0 && l.evento.includes('Migra√ß√£o')) {
                                 valorMultasPagas += val; // Soma se foi inserido manualmente na migra√ß√£o
                             }
                        }

                        tbody.innerHTML += `
                            <tr>
                                <td class="py-3 font-mono text-[9px] text-slate-400">${new Date(l.created_at).toLocaleString()}</td>
                                <td class="py-3 font-bold text-[10px] text-blue-400">${escapeHTML(l.evento)}</td>
                                <td class="py-3 text-[10px] text-slate-300">${escapeHTML(l.detalhes)}</td>
                                <td class="py-3 text-right font-black ${corValor}">${val !== 0 ? val.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : '-'}</td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-slate-500">Nenhuma movimenta√ß√£o encontrada.</td></tr>';
                }

                document.getElementById('ext_vida_pego').innerText = totalPegoVida.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                document.getElementById('ext_vida_dias').innerText = diasAtrasoVida;
                document.getElementById('ext_vida_multas').innerText = valorMultasPagas.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});

            } catch(e) { showToast("Nenhum cliente encontrado", "error"); }
        }

        // =====================================
        // AUDITORIA (LOGS)
        // =====================================
        async function carregarTodosLogs() {
            try {
                const res = await fetch(`${API_BASE}/api/logs-auditoria`, { headers: headersAuth });
                if(!res.ok) return;
                const lista = await res.json();
                const tbody = document.getElementById('lista-todos-logs');
                tbody.innerHTML = '';
                lista.forEach(l => {
                    const val = parseFloat(l.valor_fluxo) || 0;
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-800/30 border-b border-slate-800/50">
                            <td class="px-6 py-3 font-mono text-[10px] text-slate-400">${new Date(l.created_at).toLocaleString()}</td>
                            <td class="px-6 py-3 font-bold text-[10px] text-orange-400">${escapeHTML(l.evento)}</td>
                            <td class="px-6 py-3 text-[10px] text-slate-300">${escapeHTML(l.detalhes)}</td>
                            <td class="px-6 py-3 text-right font-black text-slate-300">${val !== 0 ? val.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : '-'}</td>
                        </tr>
                    `;
                });
            } catch(e) {}
        }

        // =====================================
        // LISTA NEGRA
        // =====================================
        async function carregarListaNegra() {
            try {
                const res = await fetch(`${API_BASE}/api/lista-negra`, { headers: headersAuth });
                if(!res.ok) return;
                const lista = await res.json();
                const tbody = document.getElementById('lista-negra-body');
                tbody.innerHTML = '';
                lista.forEach(l => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-800/30 border-b border-slate-800/50">
                            <td class="px-6 py-3 font-mono font-bold text-red-400">${escapeHTML(l.cpf)}</td>
                            <td class="px-6 py-3 text-xs text-slate-300">${escapeHTML(l.motivo)}</td>
                            <td class="px-6 py-3 text-xs text-slate-500">${new Date(l.created_at).toLocaleDateString()}</td>
                            <td class="px-6 py-3 text-center"><button onclick="removerListaNegra('${escapeHTML(l.cpf)}')" class="text-[10px] font-bold text-slate-400 hover:text-white uppercase"><i class="fa-solid fa-trash"></i> Remover</button></td>
                        </tr>
                    `;
                });
            } catch(e) {}
        }

        async function adicionarListaNegra() {
            const cpf = document.getElementById('ln_cpf').value.replace(/\D/g, '');
            const motivo = document.getElementById('ln_motivo').value;
            if(cpf.length !== 11 || !motivo) return showToast("CPF e Motivo s√£o obrigat√≥rios", "error");
            try {
                const res = await fetch(`${API_BASE}/api/lista-negra`, { method: 'POST', headers: headersAuth, body: JSON.stringify({ cpf, motivo }) });
                if(res.ok) { showToast("CPF Bloqueado com sucesso!"); document.getElementById('ln_cpf').value = ''; document.getElementById('ln_motivo').value = ''; carregarListaNegra(); }
            } catch(e) { showToast("Erro", "error"); }
        }

        async function removerListaNegra(cpf) {
            try {
                const res = await fetch(`${API_BASE}/api/lista-negra/${cpf}`, { method: 'DELETE', headers: headersAuth });
                if(res.ok) { showToast("CPF Desbloqueado"); carregarListaNegra(); }
            } catch(e) {}
        }

        // =====================================
        // RELAT√ìRIOS (COM FILTRO AVAN√áADO)
        // =====================================
        function verificarFiltroData() {
            const val = document.getElementById('filtro-relatorio').value;
            if (val === 'custom') {
                document.getElementById('datas-customizadas').classList.remove('hidden');
            } else {
                document.getElementById('datas-customizadas').classList.add('hidden');
            }
        }

        async function carregarRelatorios() {
            try {
                const val = document.getElementById('filtro-relatorio').value;
                const hoje = new Date();
                let dataInicio, dataFim;
                
                dataFim = hoje.toISOString().split('T')[0];

                if(val === 'mes') {
                    dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
                } else if(val === 'semana') {
                    const diaSemana = hoje.getDay();
                    const diff = hoje.getDate() - diaSemana + (diaSemana == 0 ? -6 : 1);
                    dataInicio = new Date(hoje.setDate(diff)).toISOString().split('T')[0];
                } else if(val === 'semestre') {
                    const mes = hoje.getMonth();
                    const inicioMes = mes < 6 ? 0 : 6;
                    dataInicio = new Date(hoje.getFullYear(), inicioMes, 1).toISOString().split('T')[0];
                } else if(val === 'ano') {
                    dataInicio = new Date(hoje.getFullYear(), 0, 1).toISOString().split('T')[0];
                } else if(val === 'custom') {
                    dataInicio = document.getElementById('data_inicio_rel').value;
                    dataFim = document.getElementById('data_fim_rel').value;
                    if(!dataInicio || !dataFim) return showToast("Preencha as datas de in√≠cio e fim", "error");
                }

                const res = await fetch(`${API_BASE}/relatorio-periodo`, {
                    method: 'POST',
                    headers: headersAuth,
                    body: JSON.stringify({ dataInicio, dataFim })
                });
                
                if (!res.ok) throw new Error();
                const dados = await res.json();

                const entradas = parseFloat(dados.totalRecebido) || 0; 
                const saidas = parseFloat(dados.totalEmprestado) || 0; 
                const emprestado = parseFloat(dados.totalEmprestado) || 0;
                const liquido = entradas - emprestado;

                document.getElementById('rel_recebido').innerText = entradas.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                document.getElementById('rel_saida').innerText = saidas.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                document.getElementById('rel_emprestado').innerText = emprestado.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                document.getElementById('rel_liquido').innerText = liquido.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                document.getElementById('rel_liquido').className = liquido > 0 ? "font-black text-emerald-400 text-lg" : "font-black text-red-400 text-lg";

                const ctx = document.getElementById('graficoRelatorio1').getContext('2d');
                if(chartInstanceRel) chartInstanceRel.destroy();
                chartInstanceRel = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: ['Recebido', 'Emprestado'], datasets: [{ data: [entradas, emprestado], backgroundColor: ['#10b981', '#3b82f6'], borderWidth: 0 }] },
                    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } }
                });
            } catch(e) {
                showToast("Erro ao carregar relat√≥rio.", "error");
            }
        }

        // =====================================
        // CONFIGURA√á√ïES
        // =====================================
        async function carregarConfig() {
            try {
                const res = await fetch(`${API_BASE}/api/config`, { headers: headersAuth });
                if(!res.ok) return;
                const confs = await res.json();
                
                window.sistemaConfig = { valor_minimo: 500, juros_unico: 30, juros_parcelado: 25 }; 

                confs.forEach(c => {
                    if(c.chave === 'juros_unico') { document.getElementById('conf_juros_unico').value = c.valor; window.sistemaConfig.juros_unico = parseFloat(c.valor); }
                    if(c.chave === 'juros_parcelado') { document.getElementById('conf_juros_parcelado').value = c.valor; window.sistemaConfig.juros_parcelado = parseFloat(c.valor); }
                    if(c.chave === 'multa_diaria') document.getElementById('conf_multa').value = c.valor;
                    if(c.chave === 'valor_minimo') { document.getElementById('conf_minimo').value = c.valor; window.sistemaConfig.valor_minimo = parseFloat(c.valor);  }
                    if(c.chave === 'caixa_total' || c.chave === 'conf_caixa_total') { document.getElementById('conf_caixa_total').value = c.valor; }
                });

                document.getElementById('cad_capital').placeholder = `M√≠nimo R$ ${window.sistemaConfig.valor_minimo}`;
            } catch(e) {}
        }

        async function salvarConfig() {
            const jurosUnico = document.getElementById('conf_juros_unico').value;
            const jurosParcelado = document.getElementById('conf_juros_parcelado').value;
            const multa = document.getElementById('conf_multa').value;
            const minimo = document.getElementById('conf_minimo').value;
            const caixaGeral = document.getElementById('conf_caixa_total').value; 

            try {
                const res = await fetch(`${API_BASE}/api/config`, { 
                    method: 'POST', headers: headersAuth, 
                    body: JSON.stringify({ configs: [ 
                        {chave: 'juros_unico', valor: jurosUnico}, 
                        {chave: 'juros_parcelado', valor: jurosParcelado}, 
                        {chave: 'multa_diaria', valor: multa},
                        {chave: 'valor_minimo', valor: minimo || 500},
                        {chave: 'caixa_total', valor: caixaGeral || 50000}
                    ] }) 
                });
                if(res.ok) { showToast("Configura√ß√µes atualizadas!"); carregarConfig(); carregarDash(); } 
                else { throw new Error(); }
            } catch(e) { showToast("Erro ao salvar configs.", "error"); }
        }

        // =====================================
        // SA√çDA DE CAIXA E PROMOTORES
        // =====================================
        async function carregarSaidas() {
            try {
                const res = await fetch(`${API_BASE}/api/extrato-caixa`, { headers: headersAuth });
                if(!res.ok) return;
                const lista = await res.json();
                const tbody = document.getElementById('lista-saidas');
                tbody.innerHTML = '';
                lista.forEach(s => {
                    const val = parseFloat(s.valor_fluxo) || 0;
                    tbody.innerHTML += `
                        <tr class="border-b border-slate-800/50">
                            <td class="px-4 py-3 text-xs text-slate-400">${new Date(s.created_at).toLocaleDateString()}</td>
                            <td class="px-4 py-3 text-xs font-bold text-white">${escapeHTML(s.detalhes)}</td>
                            <td class="px-4 py-3 text-xs font-black text-red-400 text-right">- ${Math.abs(val).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                        </tr>
                    `;
                });
            } catch(e) {}
        }

        async function registrarSaidaCaixa() {
            const m = document.getElementById('saida_motivo').value; const v = parseFloat(document.getElementById('saida_valor').value);
            if(!m || !v) return showToast("Preencha todos", "error");
            try {
                const res = await fetch(`${API_BASE}/api/saida-caixa`, { method: 'POST', headers: headersAuth, body: JSON.stringify({ motivo: m, valor: v }) });
                if(res.ok) { showToast("Sa√≠da Registrada!"); document.getElementById('saida_motivo').value = ''; document.getElementById('saida_valor').value = ''; carregarSaidas(); carregarDash(); }
            } catch(e) {}
        }

        async function carregarPromotores() {
            try {
                const res = await fetch(`${API_BASE}/api/promotores`, { headers: headersAuth });
                if(!res.ok) return;
                const lista = await res.json();
                const tbody = document.getElementById('lista-promotores');
                tbody.innerHTML = '';
                lista.forEach(p => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-800/30 border-b border-slate-800/50">
                            <td class="px-6 py-4 font-bold text-white">${escapeHTML(p.nome)}</td>
                            <td class="px-6 py-4 font-mono text-purple-400">${escapeHTML(p.cpf)}</td>
                            <td class="px-6 py-4 text-xs text-slate-400">${new Date(p.created_at).toLocaleDateString()}</td>
                        </tr>
                    `;
                });
            } catch(e) {}
        }

        async function adicionarPromotor() {
            const nome = document.getElementById('promo_nome').value; const cpf = document.getElementById('promo_cpf').value.replace(/\D/g, '');
            if(!nome || cpf.length !== 11) return showToast("Nome e CPF v√°lidos s√£o obrigat√≥rios", "error");
            try {
                const res = await fetch(`${API_BASE}/api/adicionar-promotor`, { method: 'POST', headers: headersAuth, body: JSON.stringify({ nome, cpf }) });
                if(res.ok) { showToast("Promotor Adicionado"); document.getElementById('promo_nome').value = ''; document.getElementById('promo_cpf').value = ''; carregarPromotores(); }
            } catch(e) {}
        }

        // =====================================
        // CADASTRO MANUAL E MIGRA√á√ÉO
        // =====================================
        const getBase64 = (file) => new Promise((resolve) => { if(!file) return resolve(null); const r = new FileReader(); r.readAsDataURL(file); r.onload = () => resolve(r.result); });
        
        function marcarFicheiroCad(input) {
            if(input.files && input.files[0]) {
                const label = input.parentElement;
                label.style.borderColor = '#10b981'; 
                label.querySelector('p').style.color = '#10b981';
                label.querySelector('i').className = 'fa-solid fa-check-circle text-xl mb-2 text-emerald-500 transition-colors';
            }
        }

        async function salvarCadastroRapido() {
            const btn = event.target; btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Enviando...`;
            try {
                const dados = {
                    nome: document.getElementById('cad_nome').value, 
                    cpf: document.getElementById('cad_cpf').value.replace(/\D/g,''),
                    whatsapp: document.getElementById('cad_zap').value.replace(/\D/g,''), 
                    valor_emprestado: parseFloat(document.getElementById('cad_capital').value),
                    valor_total: parseFloat(document.getElementById('cad_saldo').value), 
                    data_vencimento: document.getElementById('cad_venc').value, 
                    frequencia: document.getElementById('cad_freq').value,
                    // üö® CORRE√á√ÉO: Pega as parcelas e os juros j√° pagos da tela
                    qtd_parcelas: parseInt(document.getElementById('cad_parcelas').value) || 1,
                    juros_pagos: parseFloat(document.getElementById('cad_juros_pagos').value) || 0,
                    capital_pago: parseFloat(document.getElementById('cad_capital_pago').value) || 0,
                    img_selfie: await getBase64(document.getElementById('cad_selfie').files[0]), 
                    img_frente: await getBase64(document.getElementById('cad_frente').files[0]),
                    img_verso: await getBase64(document.getElementById('cad_verso').files[0]), 
                    img_residencia: await getBase64(document.getElementById('cad_residencia').files[0]), 
                    img_casa: await getBase64(document.getElementById('cad_casa').files[0])
                };
                if(!dados.nome || !dados.cpf || !dados.valor_emprestado) throw new Error("Faltam dados obrigat√≥rios");
                
                const valorMinimo = window.sistemaConfig?.valor_minimo || 500;
                if(dados.valor_emprestado < valorMinimo) {
                    throw new Error(`O valor m√≠nimo permitido pelo sistema √© de R$ ${valorMinimo}`);
                }

                const res = await fetch(`${API_BASE}/api/migrar-cliente`, { method: 'POST', headers: headersAuth, body: JSON.stringify(dados) });
                if(res.ok) { showToast("Cadastro Realizado/Migrado!"); document.getElementById('formCadastroRapido').reset(); mudarAba('aberto'); carregarDash(); } else { throw new Error("Erro de servidor"); }
            } catch(e) { showToast(e.message, "error"); } finally { btn.innerHTML = `<i class="fa-solid fa-cloud-arrow-up mr-2"></i> Inserir no Sistema`; }
        }
    </script>
</body>
</html>